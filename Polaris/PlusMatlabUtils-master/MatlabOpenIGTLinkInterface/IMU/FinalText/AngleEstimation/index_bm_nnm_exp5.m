function [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 14:36:45.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 5xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 5x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 5x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.44187443254308;-0.290030409875722;-0.21809646746465;-0.200358474000746;-0.141009323793073];
x1_step1.gain = [2.50434222911229;3.42805241045766;5.25791464388626;6.06885454376742;7.36657891744156];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];
x2_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.092139163543452473615;0.16431329279215073358;-0.072239326737090422959;-0.064140951884855829102;0.090859330291669759827;0.025438756900185870158;0.07977443410996008788;0.25792960128622316462;-0.11535462010489010154;0.0027498603043284190403];
IW1_1 = [-0.3333868102320174942 0.44861109332367637981 -0.14595793098320625214 0.15549294609705793802 -0.6447211659092212388 -0.20288936799670426181 -0.10423606391927582593 -0.032061830707456981382 -0.32777403947074928992 0.095182508860405953821;-0.26562162545260337154 -0.10243634279626273598 0.69772192976436664402 0.22303105719479221491 -0.2483745321731598843 0.94678086293694541098 -0.22477586961814235988 -0.40811785828137980836 -0.30571590513245355814 0.51770748689474732629;-0.13894194152098734985 0.38305840678525421295 0.31612628297170125569 -0.24915330644862504483 -0.16615380815056368657 0.27959527244271881186 -0.61956207866264489947 0.20397770986344299082 -0.040964944369943107061 0.32230595807290218779;-0.3252781827630537026 0.90079117025074351144 0.11999140640795359636 0.66864017736072189901 -0.54059200033321774814 0.23364804038389716534 -0.24202273778129329562 -0.048794692650158115466 -0.54467113930934485388 0.28072600691731408595;0.1989296407755377083 0.26149475587201659321 0.90599307128041972614 0.57410643242083558846 0.23174874817160409646 -0.14901752013647789896 -0.48912618329623941404 -0.75107653018101860898 -0.55767489530487346361 -0.31081492364853419152;0.1130003478981609355 -0.38304869487316567378 -0.41874799367514980997 0.37350312506117933076 0.46731712698523714122 -0.29007778349345636482 -0.030647734073203515559 0.11353293923393451004 -0.11349571887997106368 -0.17623701183633175282;-0.3614889530232461845 0.74226016094380042887 -0.090022634973196111186 0.95660291235497640905 -0.13357895950204054514 0.1471067724101514651 -0.68169160251741212075 0.20518549058954915765 -0.77830188934244137755 0.24908842451082299774;-0.37798260665800187397 -0.064915707136944389433 0.33167283657053858725 0.2481712339813101631 -0.19447338975907813019 0.8266298116687557096 0.0037859305005281248743 -0.18336592115579408713 -0.27260297816881234878 0.37819341650842625002;-0.19536860477062883978 0.12745140899159157488 0.15819078468491507006 -0.29358156478416297386 -0.30398992637913824222 -0.22166606756076884244 -0.46182798210130587835 -0.093024722251785416094 -0.13487863340977182536 0.006594967403924294376;0.035186796599716262113 0.031003450525686395561 0.1971138889902876723 -0.10440011180456022777 -0.19002547952383461172 0.20319826709808139209 0.49292351061331057815 -0.25037420340161831156 0.17518957999819212423 -0.0014109800211285620543];
IW1_2 = [0.21768702471643774921 0.76658285795063085821 0.37581815135028689978 0.048223412651794417272 -0.57676020958424234486 -0.20545185223265760577;-1.9007522562855068138 -0.2097622640662178406 -0.13009667394934754103 -0.5140191664215428835 -0.23917690860737533809 0.4382516325447298744;-0.41648287066264588763 -1.0612855865054431348 -0.97581356994911816471 0.3765211833684879994 0.46256610598322273065 0.84138488598378857741;-1.2217347165828713607 0.60400766829558749649 -0.65031844050313114547 1.2644277492803801533 0.15656032512401957257 0.39875069244927296985;-1.4094799763524989977 -0.64486805905714283949 2.0738537933710787797 1.0803971290243139514 0.42403923238220087022 -2.0634874421807318789;0.32021402159631801032 -0.83711335923524676783 0.32730206424024926859 -0.16301163938884616345 -0.036909817116413418114 -0.21190983980020031141;-0.32164453803233539197 -0.51100251392120166205 0.15614734092152735001 0.99396786857519670022 0.27927128300442644049 0.11051652339017929705;-0.866869213547096229 0.10607665559817264223 0.36153935884640464593 -0.86710304551910444282 -0.19416594417297491915 0.014964433650082199084;0.30474191700087532864 -0.46537956159707011272 -0.16359747546312095046 -0.29196677451824715188 -0.3891620580956518527 -0.045775529134444124801;-0.5708767127898082272 0.66329082582703335902 -0.64374967881735989383 0.016751680214785881484 0.10742353165325960185 0.065213855621662528139];

% Layer 2
b2 = [-0.21065778465406145847;-0.276512614515106947;-0.12322255405358001346];
LW2_1 = [-0.36097381241185405587 -0.045000855605513472024 -0.71103423419885170009 -0.007350742073348858624 -0.076273454816186275762 -0.93437035451472039149 0.096556009812555312899 0.086607237600251893439 0.023220818576708619069 -0.96698744488986232426;1.5317682142744430962 -0.11624132666907466271 0.91411389629243167132 -1.2864884419410194116 0.3306226889723877238 0.24245097133000242939 0.41552651284955716138 0.066711072941253432567 -1.229862458855582652 0.65138657372329866746;0.44558156591857389639 -0.67911029294105051957 0.6608538345662072766 1.3474539966122347501 0.38807549638399346792 0.79585839461464069622 -1.6341607652478344903 0.86413382951439765556 -0.69608688294671972052 -1.2047721943539926315];

% Layer 3
b3 = [-0.26827886162507458279;-0.061689103657643795664;0.4458965832265217033];
LW3_2 = [0.11270336599294214497 0.66512897033568862959 -2.1252873992918051016;1.5042538231741393595 -2.0189198316626004726 0.48378313080453844153;0.3773625620694769367 1.1934782063724882484 1.0410857130186603747];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
y1_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(5,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),10,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
