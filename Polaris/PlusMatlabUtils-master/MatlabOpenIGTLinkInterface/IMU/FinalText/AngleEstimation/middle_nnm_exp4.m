function [y1,xf1,xf2] = middle_nnm_exp4(x1,x2,xi1,xi2)
%MIDDLE_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 05:47:29.
% 
% [y1,xf1,xf2] = middle_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.2872;-0.1512;0.736;0.3377;-0.3962;0.0385;0.5888;0.3788;-0.3399;0.0772;0.8158;-0.3435;-0.2594;-0.0021;0.877;0.18];
x1_step1.gain = [6.46412411118293;7.58725341426404;9.92063492063492;6.25978090766823;6.6511473229132;9.68992248062015;6.83526999316473;5.94530321046374;4.53720508166969;7.01016473887136;11.7508813160987;2.26449275362319;6.91802144586648;11.2170499158721;20.9643605870021;7.35023888276369];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-39.50838032;-56.20691974;-13.03478832];
x2_step1.gain = [0.0195047175707841;0.0395706711489379;0.0539272120771512];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.024694250952077490685;0.59810690452734482925;-0.34083713178952673717;0.016212950527629315517;-0.48703418114044699783;-0.32663696854388490909;-0.45905084506516047327;-0.10152003367934432643;-0.88277783722542912948;-0.14414028861010486082];
IW1_1 = [-0.050327040282625440382 0.16166110308299061482 0.20044487580273842586 0.2519221758509405662 -0.069376782861438487937 0.084559584385232977599 0.17760867156912010789 -0.026424467435111599622 0.10647916384115341248 -0.039536879950117308213 -0.09132465090055330581 -0.13437334100132855563 -0.13617590520282024658 -0.079233974424362405009 -0.029029533436524417034 -0.065778688824740264018 -0.015567458039750077525 -0.15370897951476691912 0.027867746352554782774 0.019485871411876364706 -0.010470252810373005883 -0.058765040014738159635 -0.13955147741538453943 0.04909465914755930388 -0.13841034020514880742 -0.014074816302915333852 0.033364852486787145713 0.11134984034424359745 0.37338955651809352387 -0.03494213885393844532 -0.21671126091370401801 -0.16277244838877591437;-0.12691568231708302839 -1.8112036649985185921 0.42554252351514060271 0.094230210872697547919 0.44966885572633563672 0.29022588420840911283 -1.0291410381296619558 1.2422419355864642299 0.061109352980675026024 -0.82798001341080285087 -0.82016901071806802559 -0.35375754856445962293 -0.26055080626687326939 0.15858327342769365509 1.222852557972088583 0.98744316853531766132 0.14420324810192738929 1.6474303490462756105 -0.89753735695951741835 -0.14609760473221977684 0.12689486770245919645 -0.1676882753682718552 -0.19390515453130360846 -2.1852913946880807572 -0.19665912462785217762 -0.10078876234499437037 -0.43788007165035952584 0.79436666499359687155 -0.35556865160300660245 -0.20833615115127793183 -0.0058097637691483447475 0.14561216919494429645;0.08609735908709072183 -0.48257650407267715931 -0.29166330917930077815 -0.44863430858750069641 0.25477639633045007228 -0.044620969395507678601 -0.57732109019457400478 -0.047078456136353266648 -0.25980463316537255603 -0.053354754689405009538 -0.18858395509936007328 0.36081420870043950933 0.23395730141009793424 0.14051207813270885638 0.22659896715267946465 0.097400375832732366543 -0.038773747939571355514 0.54250830178241837842 0.20048913914503713185 0.22074698948127874365 -0.0056549664737008962026 -0.011668682902979111288 0.24782768073557262523 -0.47048016454932439778 0.17703712751258976477 0.014568901957355821775 0.1523568748867704381 -0.15786231594725755323 -0.38024422840915428345 -0.19337502235410949925 -0.099769183141552642002 0.31443397727773347849;-0.019734595856584664919 0.15670226287770561147 0.069232538904100790478 0.14352968181944339432 -0.077418143165378636161 0.037721624328578666485 0.1466002290258022478 -0.077349770033335277231 0.10913015179092247497 -0.0053265800913565508265 0.037599444395800422913 -0.14183849355848782148 -0.11509802056100448819 -0.088670663748372777202 -0.060345794043588252276 0.016719710808271417285 -0.011861706315885133661 -0.16910946805443011209 -0.0076560066636455767833 -0.026229487112371108193 0.016712067153331473107 -0.018034377226470176686 -0.077035309461270226605 0.18836045505687953883 -0.073200652654562978205 -0.0015216129426454617826 -0.057402155463266428537 0.072129693655235874172 0.16427350723562883505 0.078093559088127012524 0.010452336055707374049 -0.11707733109614001932;0.20958221681599575881 -0.32921631146355773145 -0.71287264181361198467 -0.41754613370690618623 -0.079754746788423355741 -0.34620065357692558772 -0.88101329555240259772 0.62691662645117429697 0.13376605105664388096 0.45157257396374828051 0.44169774747562429162 1.2724162236946261473 0.56705059661704748653 -0.090090826430931719715 0.39747913012721425297 0.071049186668353178642 0.093848623161528477166 0.32592568229826807125 -0.42507443859824656229 -0.82563390958786642138 0.085343033529045500551 0.28801285284882377491 1.0943288760827540873 -0.32715179481764133929 0.31004189343377808186 -0.27381026470301350617 -0.26226969801253413594 -0.8225116235725956626 -1.247139631548308536 0.51041164748077683111 0.69010025325411950003 1.0168731801554209415;0.67831956313952490589 0.35472302360402485633 -0.99397602944793128632 -0.81898263062541842849 0.63314248057870381459 -0.30459678285940872122 -0.38175315866715131552 -0.34921357966904825743 0.52355742466604338059 0.044425882761286041023 0.75088685264814081233 -0.69260043597774967328 0.05829125052052788053 0.25548214960118315053 0.085759388363917318787 -0.10791382061965930361 -0.29338288643775156661 -0.4580755753177689904 -0.62546642015044262575 -0.28350322597525179358 -0.29933654414022775603 0.33731036104182604562 0.3400235912383803849 1.1477350302138580318 0.20038649492383614481 -0.23199308938611626352 -1.2382726518541646854 0.48396562830231798502 -0.99371617844084747517 0.24626071657119147362 0.99696965125443659517 0.57564018045681308866;-0.40698169024655245218 1.216887545670140236 -0.14367659693683468292 -0.50144363387686696765 -1.3433145669690880197 -0.12987173539969062985 1.1088781868127246533 0.057954557611180609888 0.23046811772142117292 1.3334314200214119062 2.4957344438759530014 1.6196043828952246812 0.36136753599776716417 1.0137472284588993077 -0.037241526420184259405 -0.090667088711496049425 -0.32762461640512302585 -1.3228780878971042601 -0.072892198380219985765 0.53796824218348526792 0.81219162028374436435 -0.051832051201182519073 0.5151269035345693581 2.02904420079161385 2.0493598256349940812 0.040844336548620699401 -0.97554999367667827315 -0.51975110438482108322 -1.3283835324449111415 -0.10203802457028635087 0.24925491353174411557 -0.18029851156584178473;-0.25466496968906104925 0.53563555102975113353 0.45519000531311143432 0.74199241127044746058 -0.35895529746239185354 0.030410043456347062019 0.98051435392436059324 0.36884314532845363654 0.51943160575340785456 0.11656737465374593377 0.33459200007623934869 -0.59567154490250451282 -0.29534609673545669795 0.0040192562794764182671 -0.33990091981234277219 -0.19952357423808306236 0.24044373168137339603 -0.67695448548035908054 -0.58936235371799949867 -0.59254943270794113719 -0.0098142500312675927387 0.066887667270954159759 -0.49601982614004686001 0.51768485456874979711 -0.26999084906789910798 -0.090092671458242498672 -0.3713097214728938722 0.27745215119381344548 0.38984108743261663976 0.16838409674409240968 0.46031277944198328855 -0.2359185186230531861;0.21344524479603546596 -0.56099110117460004865 0.1290143996218256206 -0.52264932497840344006 0.2525292912356530417 -0.10706300000569243802 0.09546995503323815746 0.80781850994079296147 -0.87139794620065746944 0.021101166249786477286 -0.15720420574073970532 0.14405129533100319295 -0.26594658436856205563 -0.17057010208220393932 -0.5827746130447495343 0.56355096386148073595 0.3025609120333688784 0.69276049320757659977 -0.1923211657143320541 -0.095106898992049521135 -0.37279812952248297941 0.32425794073222413694 0.90943215842338342991 -0.26688898695751067658 -0.67088445873796964669 0.21212030750972982185 0.91292117061353939 -0.37473247492318140228 0.064497025049077991166 0.50025184932604238597 0.82553290142304935895 -0.84477327655459555356;0.86413293179231009944 1.4494800410482744368 0.65827292633395650956 0.90849225859745730283 -0.50301203607250066785 0.86332726624966327211 0.79681806246075159716 -1.1792756543310887185 0.49587942061288792228 -1.066294740289045917 -1.8154648693841273221 -0.39456897204687152447 0.093900064109904840537 -1.0922256957794240773 -0.26700964752854089435 0.22211154465124910429 -0.90181039273556184988 -1.2680261833974668662 0.54837454212204472803 0.26610322143467624034 -0.032016826951419039005 -0.62469943956740903168 -0.39347088291095461132 0.70746742167996579109 -1.5749964919263139684 0.36393173383747062788 1.0304777255214503384 0.069842393360202204011 2.3720542141174898454 -0.18346744294740044423 -0.97775493543740488178 -0.50507171291712760208];
IW1_2 = [-0.29803144303196421605 0.12483200501036122165 -0.29451907948705868812 -0.1433180976414625829 -0.11987205277912037216 0.14381456975329190429;-1.4188562624384424282 -0.21015910607084925532 0.71177418141984738487 0.49622737786496240453 -0.84699751781371857007 -1.2244851861056609277;-0.59472252130504865697 -0.71774166498385760793 0.67073746335054840184 0.34937008133877850424 0.60345928781416158238 -0.85238203722120831074;0.093286004600708072321 0.49239104584589687974 0.096560352338265167949 -0.10646785854706419805 -0.27937037922019397618 0.10782151097867050116;-4.5234502768745636914 0.10943825297578380074 0.070905799306962988271 4.0020788789495505 0.27571185338427073308 -0.040241293730236653292;0.22677091392642728662 0.46052482683999523827 1.3465484996794025996 0.027839466484212611191 -1.198954118774782307 -0.69431663427722167814;-0.70138819195637158721 -0.25713555561785517156 0.72374584844643718995 0.56434290393009356457 1.4950689828452798924 -0.1973120387235609563;0.96323924478617228839 0.59649814386210342487 -0.57629505096022781707 -0.4219203682792216914 -0.84082976338973480779 1.1648756491301683891;1.6291551719629702166 0.49333568740213451509 -0.82420822319824582625 -0.3599446135186232798 -0.39656498822738756038 1.497852501293694516;-1.6174017528494819551 1.4052944490875522998 -2.1878351058052794009 0.56983516412302270826 -0.60942324954034521323 0.83305784694119755507];

% Layer 2
b2 = [-0.61446589318032585059;0.93797607783776082435;-1.1180803077068128815;-0.2166848281701891088;0.24374882385483348513;0.41085906448745007635;0.55675907414551195629;-0.33698012613611544319;0.49205495032075463602;0.19828521076457650274];
LW2_1 = [-1.5018269497347658259 -0.033914909250087825476 0.32759208037853299045 -0.46478314995855446456 2.1612012188294458248 -0.68719980145968284635 -0.08482019448510086379 0.37035027273786663704 0.28238493149315163633 0.83253330358411048451;0.46972822341762809906 2.3615997892278346448 0.1115966029419138833 -0.098587513976354998468 -1.8052989417143874284 0.48206825199132247173 2.7642249900202870982 -0.39282927852342841568 2.0313874206983135728 2.190497181628523915;-0.20049379750027232494 -0.51081518479994814097 0.77858339114242502976 0.45265780502167618504 0.4459994195149753482 0.87782547781504427498 -0.88564818406748391233 -1.6780141810659467971 -0.29781703384018615166 -0.41083331970673669931;0.32415086846141832888 0.16987889587224938581 -1.6207986167404262456 -0.054106965855137335863 0.74605146979384173722 0.026992222454686739391 -0.053518647207758722473 0.04621711304513219376 0.21635973837067296044 0.090649761882473339769;1.2834384913746903489 0.47012934380636073328 1.0987139012073283695 0.31421750166190504094 0.025591636101602192876 -0.66610851801824355611 0.33923170588872481046 0.57170011076396576311 -0.54902531378111096849 -0.30173848331352798313;0.66781347708308658184 3.3997121627534090393 0.68264917331461305583 -0.24915464169849702025 -2.5273730422192284273 0.33235806838181408684 3.8193065892337982881 -0.037839002161528051404 2.8106581220525392872 2.9900928010458596162;0.20735981188836219435 -0.068653547270880493913 0.74917385370149003343 -0.47325485766853020442 0.19381826878976646245 0.1266895871919585248 -0.053615158717368903429 0.64924760317995766634 0.096360599345864675347 0.054065713565792344886;-0.61519479271755450611 0.5030630639451245667 0.83616617366995182881 -0.24644835507689816234 1.2808682868599827742 -1.4291969589895550108 -0.23607960832653446248 1.2515097797258785128 -0.0099095482625730941378 0.34261464674405550657;0.058504404169215477871 -0.11584100677054938455 1.3181712892186647768 1.7104475480647931551 -0.050296307686191914221 0.05763167486962972319 -0.028669407893257486258 0.11716715126218031628 0.086456369838024765828 0.011973758418982731466;0.61422490210602642691 -0.10303577356535489895 -0.52543468953554595124 0.1935404823152306053 -0.190930199675789114 0.32240017454325597956 0.063379672558882410582 -0.80620107916353689337 0.1296587067796693693 0.00183245485281210139];

% Layer 3
b3 = [-0.99415001592318497092;1.3433739947807401549;-1.1359377808621331507];
LW3_2 = [0.23159341422581261605 4.0771487498110960956 0.40447894561762876009 -0.43172935327097339275 -0.59905697925746759225 -1.5694982071280465519 -1.6326603467119422675 -0.37091532227496254448 -0.58991349173074936196 -2.4251481168182147385;0.10951414618956950564 0.30352230718839789958 1.1604194873486164408 0.95458786197423473041 -0.24136742091862339876 -0.10486064323156045475 -2.5604831377950341142 -0.33426719026505430366 0.31825295142665249726 -1.0002203852617546076;-0.040438491785354475916 -0.39273242370276767454 -1.527394381944570334 -0.22987185716109648226 0.26135559131741731287 0.11234614071158884052 0.85890162528323565905 0.0029818923107473105719 2.2574699557352504442 -0.61579362002138859911];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0195047175707841;0.0395706711489379;0.0539272120771512];
y1_step1.xoffset = [-39.50838032;-56.20691974;-13.03478832];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
