function [y1,xf1,xf2] = thumb_bm_nnm_exp4(x1,x2,xi1,xi2)
%THUMB_BM_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 15:08:34.
% 
% [y1,xf1,xf2] = thumb_bm_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 4xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 4x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 4x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.272484189700909;-0.21676763725856;-0.180517740526315;-0.162560619199683];
x1_step1.gain = [3.00685442929844;3.19703941041068;4.74195484082141;7.50272416774596];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;8.007185151;25.69303831];
x2_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.024794413395801077199;0.16608926725048289708;0.053088979958986544372;-0.074767973247039265505;0.54910702545107759054;0.44149938150665529735;0.16712845434413023393];
IW1_1 = [0.42284614280190430113 0.24613686193779243938 -0.32910219553695591044 0.10944271940530175824 -0.20869849820035554777 -0.30511880904227295375 -0.13446072583458648642 -0.045209476623088676317;-0.050072932104813748511 -0.74080735603446745685 0.30287421786275531277 -0.38270004806683549647 -0.16028897565480595966 0.86463093498767062961 0.45259734790638239676 0.19603111518766028198;0.020930796527909332344 -0.0049420400397064889395 -0.11331610114208166828 0.053985498735653260349 0.04539353067011150239 -0.0012545816741866770271 0.1365794272007520016 -0.065369775921862410817;0.31474538291017961633 -0.48087589304676536806 -0.30908188169349126717 0.068145018395443762715 -0.50153279999426114699 0.42326075163008003432 0.25902368304789341602 -0.084378652577122376099;0.48975286736846623814 -1.1652947591228073332 0.61237380384461015392 -0.81182933112718558277 -0.89860966188170710023 1.0476652064507259166 -0.21531848888949556287 0.54225239479646236695;0.43691456894178826165 0.89528317390413525434 -0.95630924241452985868 0.67764531625960511274 0.15031377059037795418 -0.97842311248244273614 0.0036443357519594689331 -0.48767461454271304744;-0.46013216122464717373 0.64161175621163146765 0.72962197472137624299 -0.47581951799818644755 0.80513869540813309822 -0.33156057040192959962 -0.11743177327846998637 0.4290439724567790547];
IW1_2 = [-0.43682768352330492156 -0.4811327030154656792 1.0552967204459542394 0.39449680438509293623 0.014501948876841167999 -0.66159740977477621282;0.39565362097432360544 -1.373039486081081062 -0.76933070255417956851 -1.3892288577806455319 0.63933064238368020327 0.88946571468034463237;0.43767524588408412978 -0.076630929777795009361 -0.11205271569558676592 -0.67042265164264835953 0.3149876952317428036 0.31033980687687695577;0.45920718993149634013 -0.49999545326801281275 -0.63748814777083251393 -0.77938443200939599986 -0.18218875001288648008 0.11044674335607994331;-1.5350441488860551154 -1.7462492625295169546 1.6006014860206601025 0.34238844398426165894 -0.2793124408944911985 -1.1117337145451215985;2.7048492461008204479 1.35050347098535517 -0.90645670879738204917 -1.7026438996776205315 0.016676615080358492965 0.85008077346485866332;-1.2205078530929935887 0.64698565014695741393 -1.3734583796237558317 0.89584847115885302138 0.045858961297717951155 1.3125891125521693681];

% Layer 2
b2 = [-1.997517175213618934;-0.42662382207819882218;0.37722637230694144872;-0.20007163341238765053;0.38227454173790287317;-0.22791963663581055188;-0.69709119258724461243;1.2176893165015683085;-0.108932456294953392;0.23701558350431750632];
LW2_1 = [-0.21275072183376572688 -0.10409817654211202254 0.89849064358413932574 0.38972520599176901923 1.2578024332021711107 2.2118465769414430433 1.3905174753058622272;-0.65575445852231939448 0.11404051055460523445 0.93264569342994674273 0.22125166515128888434 0.37242644012527631459 0.3856057033252292543 -0.32647986626100367058;0.85082345893110788992 0.3742141709480958367 -0.081673087467088886782 0.37188322323895922628 0.23184577249076143701 -0.50132486905297868329 -1.0145114110920143702;0.57921570012563272645 0.35439976157501895671 0.81469711980441039678 0.69444486708712915846 0.41748392762690472724 0.45557476995277901288 0.16545472859656223941;1.174741323451836239 1.0801499907566129988 0.14876223557099674255 0.22691324593199965753 -1.3678079810221954737 1.3494641904841033764 -0.49406575548840886425;1.5281640212902782849 0.9137850764149375582 -0.10037193796516624689 0.51017822828343684094 0.60168834240093482801 0.57070124797828669649 -0.54935196973169775347;-1.4970042228476421187 0.79674466475297467394 -1.7240916140508133481 -0.53193906350190078847 -0.10401871917409989676 1.3501910334344087161 -1.6954778028461019446;0.58708088085447540649 0.33379669828581481905 0.019458949625502982433 0.076921888348326902807 -0.45984500987595894328 -1.6971564731278070415 -1.0722261756044872971;0.49731901488741819817 0.63882165807655599821 -0.75288298796487240772 0.50873515086874387947 -0.16763763918143395615 0.60694186295615371041 0.47838072333199227471;-0.27891791323380843437 -1.2397318133930794737 1.1635317723707001569 0.94880706432192241095 0.11018437534811584277 -0.75855108383728353516 0.42103984884641293407];

% Layer 3
b3 = [0.19594198609382085241;0.14399954503235865011;-0.24420232583539172588];
LW3_2 = [-0.38653099161330384259 -0.99509960912362815932 0.32919205614896712708 0.33425005420156106428 -0.80310355246246356575 -0.10999714957201311982 0.74215631965995676467 -0.82658489622331621227 0.37226992894580368532 -1.1346289059696632595;-1.276169408458819543 1.7715923874656303028 1.4813167026098383872 0.27633349147556890424 -0.26475340012583220561 -0.60895681897113729253 -0.67539599163638464052 -2.6554151578974911629 -0.46917973606363649886 0.047138324027809055949;-0.57321396893475240475 -0.34717479054199101851 0.71220382101235801819 1.2099538938158038714 -0.1703700521532572898 -0.61242673316743090339 -0.27058642795180315455 -1.1173572098449238155 -1.5049782728373037877 -1.2855251881238953793];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
y1_step1.xoffset = [-4.60253906;8.007185151;25.69303831];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(4,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),8,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
