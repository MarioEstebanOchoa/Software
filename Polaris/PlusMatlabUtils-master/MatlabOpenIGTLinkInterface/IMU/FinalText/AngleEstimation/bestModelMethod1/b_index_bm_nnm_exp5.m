function [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 21:18:55.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.2493;-0.1243;0.7933;0.3103;-0.1695;0.1978;0.7926;0.1407;-0.2988;-0.0568;0.8838;-0.3121;-0.1378;0.021;0.8804;0.24];
x1_step1.gain = [5.88408355398647;11.9118522930316;13.550135501355;7.37463126843658;7.18648939992813;11.2866817155756;12.0192307692308;5.22739153162572;4.52488687782805;4.82858522452921;17.2413793103448;2.94985250737463;8.54700854700855;16.4609053497942;22.3463687150838;9.87166831194472];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];
x2_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.14828929379899619123;-0.048563493338413005196;0.15080742465620849968;0.24455342212630742926;-0.046818111609365685444;0.16124427312579023286;0.25206062900265063798;0.11399743957791114157;0.71986073680742179715;-0.23348675955739506271];
IW1_1 = [0.75691859201908828769 -0.5344709456816669757 -0.30843734411136197737 0.17195550111753096778 0.25087766686291385065 0.34681224369373780947 0.7144198148067439913 0.4658762506734702713 0.47369846531724613126 0.44306749282951035651 0.1146271774865603027 -1.1321846557633967745 -0.72820279872055759807 -0.17547582438505274216 -1.2815090366051915538 -0.6234540795549489145 -0.11571839173429714076 0.26540659982920683513 -0.072929686771469437456 -0.11564548456748689753 -0.14589065083968069669 -0.049001423135814549392 0.43387642503615780898 0.39330264679191201393 -0.46790277127951945824 -0.29542701091051914997 0.050636264720189630428 0.93526555142490008787 0.032557499326122063543 0.32746512103393093929 -0.44309564671891532583 -0.90737379860625899664;-0.15608703741067350701 0.089481093932427605009 0.20480183724619777097 0.33870584036238243764 -0.46088780760562808592 0.10720270456431221784 -0.023527813342507482297 -0.62409527761136041057 0.27797229790429256457 -0.12187649970654089449 -0.13589249693830701693 0.14203186970406489475 -0.095899337863745423571 -0.39911950588379413452 -0.089349382400046820085 -0.047827434166497019563 -0.14657511970519773725 -0.25412222185377686401 0.44549322199429913782 0.34660641394709384988 0.48398035319453069913 -0.36298722254158888312 -0.40034982087471138179 0.4023275690991459097 0.045708071926840461441 0.23953271074699120091 0.32960339090853352229 0.1060736951559403396 0.04010984018420598457 0.41673223064320241704 -0.11971856876257147562 -0.049775986936338889599;-0.1715813470945814212 0.32038221437063829633 0.22439317251340629156 0.15181165369909346841 0.17783613549946897248 0.029961785431744630825 0.17801914600213714079 0.38573183441622937995 0.021975109770463744502 -0.39806903530141640735 0.1211029274643097009 -0.025811638707075569565 0.69249337939272925802 0.58150897379078703153 -0.8986102700460588677 -0.25540013377957038188 -0.39951920283575592663 -0.15798684877682972472 -0.1640080258946163827 0.23789547455807547038 -0.11344257279115749215 -0.052778075589807467438 0.013322381620592280149 0.068278684950525025954 -0.72876322671577198342 0.41567179620983940591 -0.11605782366960788743 -0.50749797518133388241 0.1782270451525763133 -0.77326562166482559757 0.15882923667410001056 -0.6753873101437078974;0.33225515469770550148 -0.098647828766881967555 -0.12382336276212096982 0.099340181087902254542 -0.40367563809025264199 0.64900909612229318313 0.69948228680971602511 0.033546687446583338399 -0.10304562555994295492 -0.2853209558445438665 0.052768252127911551008 0.058814619324460803984 -0.49967224746436555982 -0.3534387786834764511 -0.24533925492846242467 0.031640783371731311113 -0.44956488769675467809 -0.074374976643609605476 0.027894620684111519349 -0.077447124522733529206 0.76858140544331188249 -0.36213860863294661252 0.096340236365351286651 0.49905244608252008476 0.54120495351870501199 0.19156348604402353986 -0.16448317793743286175 0.10735632977852249681 0.34572375672084049159 0.46968056035809147009 -0.25931379433422174774 -0.48724416893277838758;0.62314250774063295601 0.012606691230033547496 -0.055912628805058837977 0.17403097218991853135 0.28905905990690505813 0.33613276491307780836 -0.20342889856395324211 0.38541519771321380849 -0.41816057284645091752 -0.62743967583461635051 -0.10719987989695491104 0.021361832520228270921 -0.50719848213956342242 -0.21757000098237658237 -0.046349292048667792288 -0.15017856222514383568 -0.44982451684105301259 -0.048095056039751143961 -0.070684263951008824423 -0.2222354144760546879 0.029421035902418506136 -0.20684421621269200031 0.40119704734790750944 0.052408058324987662202 0.097073772095313967667 0.34680177088693459053 0.016807484997077661026 -0.045720515700268297976 0.28812870386401795431 0.23598485400740515372 -0.21424876910968498889 -0.07807094934687117127;0.4884348247282579436 -0.31534096454731291859 -0.41130273012691254131 0.10704616110921115479 0.66970709313157128495 0.054364685772427742694 -0.28591910016540267314 0.40833530856779193252 0.38299058555185916397 0.85218235475339776386 0.52371666392842697313 -1.2864378688252324778 -0.80563389459203549325 -0.24875121754138912467 -0.6764728474647335732 -0.19143533745274715629 -0.20203444629693517731 0.13490400102893435053 0.27164034829147309935 -0.58218974525527056318 -0.76499095471023070836 -0.26630714466039323574 0.038224571366548824869 -0.38747885722262809249 -0.37578141421497429642 -0.40088681374492884935 -0.024152566112958122335 1.0920296351440610394 0.90148895013796626063 0.43841430558553551311 -0.35516011165889055379 -0.54406897842594570402;-0.098119994537725782613 0.66857723815178682347 -0.45157462636147888135 -0.25001889445808928025 -0.0774165660366534919 -0.25166307709225937961 -0.11086078787139555524 0.04273641280325172348 0.31029025837326507098 0.21613067555085571647 0.13947268549414423844 -0.10802818958535456706 -0.065990459011768934361 -0.24723840380530448524 0.22610012131551093795 0.489882858973851254 0.033792228359199573406 -0.58387920848427321552 -0.30173075492400752706 -0.3736666138227123235 0.064959084201057740171 -0.35896916506648912648 -1.0666539645709016693 -0.81662267355833839666 0.083116193536969779077 0.1893486018223177747 0.26288869169289880157 0.28944946007265681676 0.099346819704104458171 0.3945863456252229895 0.56936277062158180406 0.20437439770328108546;-0.047729175330637904628 0.11024407869433384966 0.15221510032782464839 0.18576216679625753847 0.39454592077716033049 0.13994180842694839417 -0.41840371543474352833 0.27260733017417126955 -0.25229190857517203028 -0.082219139771944574346 0.36415502877669042592 -0.081823969380918751271 -0.059673771728520716429 0.14181090011294239517 -0.21343039410828548719 0.065881367280075167625 -0.51675672443269227152 -0.02675246126603374186 0.33191955237484743746 -0.25386550239776006777 -0.35538244582250355652 -0.31481526872213438928 -0.13564487929260987675 -0.3424273233300554331 -0.14516361561139062841 0.19263800731130964472 -0.20532655878609720745 -0.17936640985776983181 1.0508589413648090627 -0.25125815665000511556 0.0016493627593318314906 -0.1878183396773042968;0.47479802807657078834 -0.10532126767907380727 -0.63213177617072213721 -0.57409116951209970825 0.28242481617463965904 0.074636533156580545101 0.62531389517935431765 0.71937877998191934736 -0.15680117700522902546 0.35529693622341901316 0.12792495021932714927 -0.23982983258939211124 -0.65303970913879338944 0.079817341845046962945 0.02490982785637425867 0.19904204711179251941 0.14450692002314705076 0.21326084644701404081 -0.44282503155201707878 -0.52906014029181447356 -0.23001768333568900493 0.1602007031304783502 -0.16444577481059569068 -0.60347365144254405678 0.36904497606542097099 -0.35039365890855478369 -0.22214868138489760052 0.24319884404669045441 0.15194523143504334861 0.011494556928853753852 0.40854557880035763384 0.23358599738796897993;0.13429190252230016611 0.21196829604924821711 -0.067750849734892801268 0.053183981723038641076 0.46914127259614085697 -0.27275181979532953092 -1.0153008414044768504 0.14155413380597156592 -0.018263195066984028864 -0.20261679513889688242 0.0052771357120967908941 -0.19312515179547234956 0.0013419237593194585124 -0.10195178177114813667 0.15672507004012664611 -0.11587367529968450874 0.0044720398211193527691 -0.14996743449852945052 0.16449852057288200102 -0.089217096664773107295 -0.54871999755186162684 -0.12732213078589904587 0.017104498200011433728 -0.55284874226393143637 -0.39038845829101670448 0.27167558457940854666 0.21487743473767409452 0.072937555908320961251 0.039484354925734273245 0.10106769913024465923 0.039340461809353396982 0.35359927624888087827];
IW1_2 = [0.37623173302351781144 -0.16303676321449328546 0.029227445162530039241 -0.3901505730892296242 -0.12443297691407574634 0.15368915908043212504;-0.16951491001156179794 0.55565535669919330353 0.78016156498228994565 -0.0026799151519539712689 0.11457742498125145225 -0.38141230892960625853;-0.032122365368001906671 0.34719962112232383156 0.46730301942724422615 1.1991112494212381456 -0.077556682889105610368 -0.079644551760916434957;-0.34659723116689550304 0.29857212900397972488 -1.3084955393297559301 -0.12170357252400262893 0.25741648674599520996 1.2198251499929471109;-0.55399213384102552471 0.62726442782208036153 -0.032346928051418692707 0.085188321207310457872 -0.85854165229173040608 -0.089993485414358045937;0.030422593429777912422 -0.51737134285682173651 -0.26557975224460966812 0.086776326066236725287 0.38711629854134838036 0.36845790426949404095;-1.3335617645132757936 0.0056479762372689829714 0.48869188544406899632 0.83983586830076795149 0.23747240676763925471 -0.61912650540145253153;0.00086478273607026347192 0.41349616436386127383 0.043097885253545943629 0.7293431276006187014 0.20109943371084945674 0.47550454320905066741;0.53934651846037040546 -0.1209282433023895903 -0.15234847839265705516 -0.56210446505835409692 -0.031317751013049774378 0.27948789588042705079;-0.81111105742145073183 0.38191810422771216293 0.52556331873588613135 0.5608276090283523807 -0.69381907716501556305 -0.83059409289318264502];

% Layer 2
b2 = [0.25375268114898275051;-0.39516489261475273853;0.27636141047280271543];
LW2_1 = [0.39875641857007415592 -0.43948191873578923428 -0.43025616363685814658 -1.1335552668008195276 0.87773749711923421124 -0.15214784398840036639 0.61082545746969529876 0.4869750616662605891 -0.88529478379445913916 -1.513445597550463928;-2.0459435238100298626 1.2429139516941078991 1.4074142002300533694 0.37216108232476940998 0.4140265831069814273 1.9325926332556755405 -1.025193022889186123 -2.0734242841773897759 1.3732784264307644762 0.050901208550991158819;-0.30832713749123186187 -0.59559337270807577447 0.045911990031232120801 0.27491095791772440782 0.069606026164509754439 0.37104754073585843877 0.11951317420187698715 -0.39877119931581278545 -0.62573542104738977265 -0.15742548248398857691];

% Layer 3
b3 = [-0.60645918253815123133;-0.043191372380684385501;0.3280421017307439957];
LW3_2 = [-0.11114713968892075968 3.344594260367129035 -0.11969483188805851714;-2.158748194021332889 -0.50834560572546672041 -0.79874396117435908504;1.5072400862775652275 -1.4354281521658678322 -0.95499322492424099096];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
y1_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
