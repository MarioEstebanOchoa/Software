function [y1,xf1,xf2] = thumb_bm_nnm_exp5(x1,x2,xi1,xi2)
%THUMB_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 21:23:25.
% 
% [y1,xf1,xf2] = thumb_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.1659;-0.1251;0.8816;0.0693;0.2291;-0.1934;0.7599;0.1397;-0.7748;-0.1929;0.57;0.0952;0.0206;-0.0416;0.9459;0.082];
x1_step1.gain = [8.058017727639;5.86682311528307;25.706940874036;7.71902740254728;6.52741514360313;5.92592592592593;11.1731843575419;5.29941706412295;5.68343279340722;5.71102227298686;8.48896434634974;4.69924812030075;7.5046904315197;11.0741971207087;57.6368876080691;13.9470013947001];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;8.007185151;25.69303831];
x2_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.91988233405996533421;0.1937254434748513221;-0.022259447713300815896;-0.3544428697162858577;-0.020968578703773613908;0.11420537282891342346;-0.44139979139326879221];
IW1_1 = [-0.017367718492151639625 0.2368243873954189449 -0.21716484109767436594 -0.014914201122074512151 0.2312214514393704512 1.1269361259433539058 -0.032611697696689277703 0.12725718739106892108 -0.31709647003961538569 -0.52143199273016405115 -0.17193780913783035524 0.36703810440364259549 0.50656339623736268418 0.34816322903576391035 0.18043890839993237396 -0.89680224552610066091 0.16325573068062626536 -0.36845228555933695613 -0.13801010905965491182 -0.17379803108231886566 -0.40697452536940947887 -1.1571537353132701487 -0.14126567812422874404 -0.39634768252772584196 -0.18226062052861344287 0.18545188292397449259 -0.22509573788096373659 0.4352026091494423099 -0.6543749169214203576 0.046159285548135052524 -0.26843311177104384191 0.61049596442014497644;-0.42737634598423535071 0.25934909912961029432 0.85331097817392720373 0.3502381190353036633 0.30323291873417285158 -0.54630530878533511974 -0.10778125061649164451 -0.32517757213917569681 0.02233230085084598332 0.47587633946584023681 0.84873247821582120665 -1.06351831645269157 0.68574630281270954058 0.33268058071766876127 0.67481431444690997967 0.10152129766588477433 0.16597991478826060185 0.089262734379459127143 -0.10860012685958621292 0.41381769842844301488 -0.2550925927076263533 0.083990429986383438599 -0.51327693708032107178 -0.66694267421057995548 0.93368243244803528214 0.26483246686957895299 -0.88551857651115273296 -0.93278898077344196693 -0.22310110163027660479 -0.53632725740945230708 -0.4471178556207219823 0.21308316820709016781;-0.0086502547803730539533 -0.14286462282776390964 0.1812366455962903522 0.01739173988157649911 0.15786343123066770566 0.069132158549647215739 0.23423163979384772904 0.29236314407094915468 -0.071584898714929720565 -0.15929730536338707059 -0.12526212640210024341 -0.18760513247862706243 0.084185045379719797287 -0.15481423860480639232 0.20923764733642896685 -0.10975435024273684503 0.071326147762802910579 0.11829181892705754875 -0.23094815206388952245 -0.15295686020015411555 0.0597809832335975469 -0.042020820190151936258 0.14686491034516696574 0.16242560946400075306 -0.11104513334314075612 0.11912528464255874028 -0.20212738311012179437 0.073337030610349115967 0.11166931677840546966 0.12870550393839388925 0.0050149864268872017259 -0.087838268035489677765;-0.28302980659723858681 0.25127655394129072564 0.076105950812583658682 0.11482989697756601499 -0.40781030137554258319 0.013907653526903950014 -0.16346779650854778576 -0.24233402950441873536 0.36771516233174783572 0.69426966349115026844 0.58787501797210062193 0.045194036858620043051 -0.14872869361092766471 -0.47211258402044686822 -0.13968872603511364727 0.80102547697752701783 -0.13646009216496934879 -0.14359756181297306243 0.16864077672639582461 0.067092473410786501731 0.33861800251604640133 -0.12763430309592957435 0.018970593175683593545 -0.14556187139609705339 -0.04985629619336173074 0.013936666471108827628 0.35039153100898012827 -0.4143042849814634887 0.11769736684600647092 0.25889664034026255157 0.060728512520167060584 -0.24526501660736124699;0.12255629890476485433 0.26213590268459380228 -0.21109581215271355781 -0.0062370095069886957728 -0.41835753727990909745 0.12508181538513010733 -0.40606323479706907253 -0.57396671199500171046 0.43003109372569348068 0.5078602827547402665 0.11734975343053269392 0.27943231776654214871 -0.19585670217834705298 0.11921914023456618714 -0.35800407832607228364 0.29281054136169176738 -0.2876325977129460254 -0.19416955855448234103 0.33260684449270361274 0.25055861616236119183 0.05161063859797120762 -0.19292243106711362555 -0.2031452100645382286 -0.24505855977455290318 -0.16554141109709291646 -0.24857581456201399694 0.60041997675682146074 0.01044655319050892886 -0.023064505715909480038 -0.18312011096928196285 0.034253581524966297822 0.045521372361393072636;0.13664823337585443874 -0.17361803173165851755 -0.22105787182411396063 -0.14383515571149441126 -0.15830107943098503664 0.31204178446036556771 -0.02390039542270704781 0.52354878626225953564 -0.31848690505654708716 -0.44350500998754671667 -0.24814850223218493097 0.28882946019862154596 -0.030899574857471877321 -0.19146116470994661851 -0.040834950809528938742 -0.08497537717296534121 0.10220908252820674889 0.20573402804264162569 -0.024405820315955641803 -0.092955824569350239961 0.1409761231905221901 0.01673101986540308922 0.30880808682709054436 0.20820022937824847475 0.001928348734059801093 -0.075140946255333310178 -0.13975800229647489248 0.34464542571002787508 -0.038936370291186295223 0.25379365875145803999 -0.0067991256219697739083 -0.18794899211706075914;0.90450587888993339014 -0.70781778673916262434 0.30188112978505937667 -0.14815845656292928045 0.096306387975043317162 -0.89626280861091645047 -0.12750147867656938527 0.53341416672698693802 -0.22577711503822070482 -0.96524696684643285227 -1.1195873108916707395 -0.50853003293338061575 -0.03092628116234258373 0.18786224840283294313 0.62221611667497600529 -0.47379305198026810952 0.16520627469035434332 1.0116279829490051334 0.068743993417430371284 0.51268669811256462054 -0.13827370997367913197 1.3632511183344511174 0.046034063516289185081 0.40290168214026755855 0.55129103399642742644 -0.32172766709325795187 -0.69134028203495145881 0.30309584972084241405 0.495304140660988379 -0.36495491863144124967 -0.3488167002945551376 -0.44333717299691555169];
IW1_2 = [-0.43974569030910409806 0.088725597446421403114 -0.29312259990776035057 -0.68941995010989887138 -0.11475884810564869476 0.73522054366509070888;2.1927915616010493771 -1.0120141290840036774 -0.057973383976936576634 -0.86399736882131705773 1.0016433509345044062 0.038984330736732762668;-1.0856762494800427099 -0.95151250906436279919 1.4968572313096615289 0.93114063915219891232 0.5514483778212841969 -0.9190906243030669831;-0.19750223680307105178 0.15568407066034276043 0.65268073973013707167 0.71228257752984813767 0.36083012746352993716 -0.50621577357573999123;0.23072764725271899255 0.78531888468026367356 -0.54404674933468766262 -0.6674838055775493828 -0.48157206002093461139 0.66789775007870078039;-0.043001747204593800122 0.39093858571364897836 0.17959089376292514117 0.08694852781019897503 -0.18541797171692667168 -0.090213956830148780974;0.98087542036739172602 0.067348523083247402443 -0.13332087195566580395 -0.88394076199194959731 -0.21104354294876045972 0.050967842553382901316];

% Layer 2
b2 = [0.2545109340213005944;-0.73572589372759433779;-0.81507941192243649198;-0.56741283958399080234;-0.064803665778357055771;-1.4280059376256839521;0.049897264376515329531;0.43258103480248966122;-0.43698408402058314115;-0.05768838700498134936];
LW2_1 = [0.26927535430593591004 0.26830471704991848414 0.24439559349705275437 0.45624396475111594906 0.31193790189309411609 0.026407831876036302193 0.64019291321690763308;-0.19877996485490706524 1.6032469217480447288 -0.46595231484623156337 -0.23168487830649867054 0.64137540050514829648 0.74109744287410683761 0.88382471135912754612;-0.32995710219932244955 -0.055417010055675244851 -0.54076947038370826171 0.14983259421599284811 0.054392099964060330874 1.0531820066596764285 -0.41011650363104568129;-0.21143388218080413909 -0.24379065832039104045 0.9717951995317722913 -0.68265318257185392259 -0.0083152961476811899921 0.30373973219902844489 -1.0762004703275385165;0.47705459021810092679 1.4360823314578949894 0.21837433099745434673 -0.60746397507657123871 -0.2273753628622181 -0.17146669366377967347 -0.082230105328678040899;1.3247001810015364143 -0.52156274734031471407 1.6608700073576057044 -0.057448226882853739572 -0.7808752499914252132 -0.070607332241061665501 -1.19518270197668941;0.16843237138026806443 1.1058928494128184017 -0.10767272069009900526 0.56310323880633250671 -0.11295883196685141403 0.63580508426362514207 -0.17453631668063829263;0.609832119623479052 -1.2932854526822867847 -0.98613089417150168181 0.92000883645523312548 -1.1552501492395568228 -0.55605419573247383269 0.45044191007523548542;0.37765216142412227907 2.508072702344493532 -0.32912787885635547136 -0.053323651987757056392 -0.00074355077797237309478 0.22937863280265785582 0.52226848423261951204;-0.66283754055416732598 0.32450472484687264974 -0.13575323026951427452 0.21509343768624808457 0.86296138332244309854 -0.34312951551048309629 -1.2706437908507977053];

% Layer 3
b3 = [0.52558480466633994421;-1.2085133553900511139;-0.3696398887465985883];
LW3_2 = [-1.2245104199134335676 0.17243293023979361367 1.1086146437683583876 0.44837576347956292766 0.43029236061927605972 -0.50074976461994336052 1.2080402668132452781 -1.3926996894419616524 -0.8712681580279597604 -0.65795914654953824297;0.8699160216195725992 -0.62667678687190764286 0.66182651872107012281 -2.2167347687623988328 1.2263923926640956097 0.7638064971738031117 0.53509708156652058264 0.94326388297241559044 -0.3704300104092863033 0.31140588923690498691;1.6419199215168884809 -0.5742227768591823267 1.0285611641760892265 0.071056658399919078728 0.82709992603507720421 -0.034488335942510751908 0.6550202878868425227 -0.96515731946987459722 -0.79003476631282221199 -0.1997895731451312662];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
y1_step1.xoffset = [-4.60253906;8.007185151;25.69303831];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
