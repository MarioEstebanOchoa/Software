function [y1,xf1,xf2] = index_bm_nnm_exp1(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP1 neural network simulation function.
%
% Auto-generated by MATLAB, 27-Aug-2019 18:38:52.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp1(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 8xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 8x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 8x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.454;0.0308;0.7706;-0.3328;-0.1492;0.0097;0.8919;0.1582];
x1_step1.gain = [3.14415972331394;3.44887049491292;9.12408759124087;2.69978401727862;6.37958532695375;14.2857142857143;23.2288037166086;7.49063670411985];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.22038887;-54.61491337;-33.15052065];
x2_step1.gain = [0.0202971975872209;0.0423350850978253;0.0363858278153968];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.19374660523402070789;-0.26083796384322749384;0.44313714626952943609;0.4764621955709272827;0.076279722791988274766];
IW1_1 = [0.23638550905533839419 -0.32889640789752871974 -0.55960931119772960862 0.09763294432061940531 0.63999790123799749075 0.4834936222029045938 0.78120735384250328259 -0.13426679308767913712 0.19038782355970873539 0.15809866332571206882 0.28408059487346160044 -0.22900547008372371116 -0.32423574890442735663 -0.58825429291625763728 -0.29188869763779290434 0.55521162850217165019;0.46529373901970128014 -0.45137475588154796213 -0.58833718150662972501 0.01582875960737237242 0.22041175025014420052 0.64521160040024494453 0.54709083302542205196 -0.2671179604798270546 -0.22904183281076886947 0.28231979636005738454 0.36342633743175728478 -0.20068411239225539267 0.03555358620514547513 -0.83246460146644463141 -0.3496166431071649483 0.4297828627190939943;-0.50659672808713629433 0.46019678944878733562 0.72607788423611541173 0.0064217668980269052015 -0.61380420503473276383 -0.82157614680787183215 -0.90513948959196488531 0.71645728289213983508 0.42365242034022670969 -0.19303644411559711669 -0.46895326235989925889 0.2460435433355346313 -0.082038887601132481908 1.1702218308381739931 0.34590621880109601038 -1.2046658399346334978;-0.83812826025176390132 1.2835382367481988908 1.6025261477662204879 0.10540915959331552398 0.25019754332344606995 -0.6435252947573361082 -0.17044804738956625956 0.34040329490232601461 0.096014359464709819747 -0.85667456602453406767 -0.98830608626006410944 0.30581640431998952101 -0.2202542993476255262 0.87343162133450980011 0.28535560275309695966 -0.26046854854144069202;0.10321747255038662971 -0.082378752870690505339 -0.11633714321645881318 -0.0089536609293160897977 0.10035957381781837605 0.093930386714128774606 0.03473689488686264315 -0.020803313532523660945 -0.013722970878180546644 0.046553164629802953889 0.06090410257636758723 -0.024574136143800277138 -0.039253903527326862444 -0.10310665733425823654 -0.052471179307246762491 -0.024068213173713305653];
IW1_2 = [0.23438840499408483686 -0.91584705394863019645 1.3431597819442080421 -0.18189535374265694556 0.61076087356514230375 -1.097033095271787273;-1.1955978067223742567 1.1156512686242581189 0.60757104442672693612 0.70529964279419476991 -0.38258662876230004057 -0.63600244891940738157;1.3132700468596956167 -1.7312722882723876605 -0.85432203220871916205 -0.81671341495581006864 0.36040005367320548935 1.1770007928410666231;-1.5575246842446304196 -0.47214268212647436673 0.63962914476191390367 0.57145318329195360363 0.094582315552223850119 -0.051706001672384954704;-0.49160579203190080122 -0.2670949980554508385 -0.71425984630838934564 0.17761192021228380811 0.073051621413293854612 0.18748745699551561117];

% Layer 2
b2 = [0.093399376041995260667;0.13655943250165819558;0.049840578199348069266];
LW2_1 = [0.02612989574414536012 -1.6713340472398219294 -0.75645410559535763984 -0.49981790515738538927 -0.44339548082239543803;-0.83725445602666481726 0.30543527103901763065 -0.15804223140527728919 -0.16711918246931639631 -0.45667527607506258613;0.46668797246491089403 0.96848462473214325108 0.52344352400445903761 0.28878634532557018177 -1.2245117517120733819];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0202971975872209;0.0423350850978253;0.0363858278153968];
y1_step1.xoffset = [-34.22038887;-54.61491337;-33.15052065];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(8,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),16,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
