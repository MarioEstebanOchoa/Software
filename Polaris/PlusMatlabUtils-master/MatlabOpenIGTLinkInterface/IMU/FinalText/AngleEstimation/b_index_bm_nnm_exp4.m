function [y1,xf1,xf2] = index_bm_nnm_exp4(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 15:04:32.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 5xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 5x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 5x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.395963890646992;-0.25167455871334;-0.179220806703439;-0.218505017539669;-0.0846359555503018];
x1_step1.gain = [2.46688656815633;3.4585985335771;5.42321823082988;5.28904699348167;5.8899691022988];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-29.69847451;-53.08714143;-33.15052065];
x2_step1.gain = [0.0215259017867669;0.0437499215793593;0.0404677022966254];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.11793061420668300709;-0.50920125820958095364;-0.041532253941563838928;-0.044815968430747414597;-0.56477120444268436028;0.11855746700112267111;-0.90077982379162768733;0.12554984348746633938;-0.40513103451105725306;-0.37302097963361019461];
IW1_1 = [-0.31581911846273036382 1.0464662224508920474 -0.18377669261293738678 0.41428285962823496735 0.86235548519998084238 -0.052879209686023144477 -0.67640096908415403565 0.22981521010991634579 -0.34211462563921613 -1.0140233099340822953;0.27616905197345664735 0.26064183460276474369 -0.053333063040233233409 -0.4367832711458111139 0.86621032505014028402 0.029950362456579511516 -0.21587579246354260398 0.023604313100178624107 0.27422170916069055213 -1.0115927623352705123;-0.12358489914562964529 -0.39083936465260071813 -0.34326467090151813188 0.048017472873649776066 0.32759756018536717592 -0.0035114440636585166761 0.56161775280667369792 -0.12743214775438480024 -0.38139856524138532334 -0.64017611963270537601;1.3843712357275839153 -0.11731782101999814472 0.33535887061480218474 0.80330402369357778447 0.2223096289774582901 -0.14993616989753838498 -0.065327266082998866614 0.28049149616387347717 -0.075049033566412709506 -0.46244242854995992742;0.029990408628522837592 0.36140702830068927032 0.3226013703863402915 0.068211086814841698223 0.18190923357762237011 0.070324885677325379985 -0.40884696725644359416 -0.30089836599337499434 -0.084347992408726243929 -0.23528034429824412621;-0.34545400535034076483 -0.10595517049208189042 -0.032401234085571099797 0.0079138782607775636641 0.2959587925158165822 0.031720174109047982736 0.28749898670932416689 -0.6365051946933111271 -0.59842803963723234517 -0.69877391037917158112;0.034365098222001622119 -0.025950014726671626064 0.30361864444149688769 0.091278611651944105421 0.1469752580713422907 0.22790329140249601658 0.052361530717530406498 -0.012643131801756588364 0.23395148002045779156 -0.0013690298995723221374;-0.073077617676822387294 0.35614654332437173379 -0.17213622402724462757 0.5560244203748878622 0.54036500609094983982 -0.013786034653714611051 -0.10646154155548920306 0.38921510370986905913 -0.26006620746088782159 -0.38249125687223961556;-0.010335025564622273703 -0.21625841944850116016 -0.18122894537204173315 -0.0018304234275956002796 0.019758536639781203864 -0.033192986890480412343 0.20719125161691354098 0.15050683929713906672 0.045398580384690863376 -0.020233617484782931428;-0.43734634650806319955 0.12820095297465647355 -0.64001306985970318753 -0.49445960033592001315 0.62218011451459742656 -0.032521177191112957128 0.17261865420052349696 0.26754046042245271941 0.10365804967443127682 -0.8609426931936242644];
IW1_2 = [-0.15166686839503157325 0.56116741497833444452 0.55334549582157988024 1.1865266950649620004 0.042257271572976949636 -0.40126637402000275845;-0.50661515112095589775 -0.45262330510750392598 -0.24192255411563945433 -0.62725598612464283921 0.26992877666187092833 0.45452922838056575294;-0.080749552423772949505 -0.24895137496121566567 -1.7595684721880049395 -0.2971194274857584805 0.16180903321680636942 0.68725441806795961597;0.34026011562185015658 0.24029472932586745659 0.2948077549903861394 -0.34151029978813646215 0.65684189578267904164 0.29241197672004093366;0.21530199119157530929 -0.30768310215722788348 0.23326402528313711082 -0.43539302895057818699 0.47547516897488795173 -0.25872505433781367579;0.78582575048359715186 -0.92508516757831504851 -1.0750481947855519138 -1.0146223737331239168 0.43964787276651856596 -0.0063399437072470142193;0.33887940172138381056 -1.0949775030091493111 -0.12435069107756314966 -0.41700681069359302189 1.6443774186673982829 0.3240100313296582768;-1.8227197729816326799 0.47833234232153271082 -0.33690938994890057279 2.1087642029612339023 0.035336827405554223358 0.40113136615781613825;0.22813190836423746788 0.43828633386591520082 0.72461516619144050733 0.11893542643715311613 -0.16912863551322793176 -0.11810326049782733648;0.041156817963832012519 0.073504835446245378461 -0.38229385365314222378 -0.12703141080442253985 -0.27608746203384371132 0.1578785023195554138];

% Layer 2
b2 = [-0.63056837829253298278;-0.35652621348894575348;0.2523964944308341174];
LW2_1 = [-0.20303273940487157057 -0.091908604115173597737 -0.039049347888238231108 0.083648369735688316018 0.04825535390345294523 0.024294052141102782244 -0.082372620302719454233 0.26449551669609788762 -1.0868268394508886487 0.2663232457756847249;-0.27286080673694540488 -0.10754553980381115208 -1.1432394258026190581 0.26763337571185646935 -0.89370534018636371698 0.89430217526692767915 0.44503249912945630484 0.33089200638120896958 -0.53314825265211840399 0.51537059556498598933;-1.2634464741653559372 -0.76334924110327240232 -1.1961988493083108853 0.49340869313700524978 1.8183084130558608837 0.60847615513512076646 -0.62274346814650649584 1.2237851403220647573 -0.23583807153469590889 1.6365076305599774997];

% Layer 3
b3 = [-0.65346099111883748645;-0.07662026137531879888;0.05002171636005214167];
LW3_2 = [-0.072716549273431116407 0.84776992683880858515 -2.3221215864336586243;-0.026647693815527027927 -2.3837298327116713814 -0.11369256599875018909;-1.6500938936598390505 0.59826820636517064056 1.5048766526196002413];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0215259017867669;0.0437499215793593;0.0404677022966254];
y1_step1.xoffset = [-29.69847451;-53.08714143;-33.15052065];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(5,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),10,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
