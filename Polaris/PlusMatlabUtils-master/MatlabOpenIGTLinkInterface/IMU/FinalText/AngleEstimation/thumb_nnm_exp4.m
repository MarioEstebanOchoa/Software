function [y1,xf1,xf2] = thumb_nnm_exp4(x1,x2,xi1,xi2)
%THUMB_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 09:06:35.
% 
% [y1,xf1,xf2] = thumb_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.1659;-0.1251;0.8816;0.0693;0.2291;-0.1934;0.7599;0.1397;-0.7748;-0.1929;0.57;0.0952;0.0206;-0.0416;0.9459;0.082];
x1_step1.gain = [8.058017727639;5.86682311528307;25.706940874036;7.71902740254728;6.52741514360313;5.92592592592593;11.1731843575419;5.29941706412295;5.14535631592488;5.22875816993464;8.48896434634974;4.64252553389044;7.5046904315197;10.5042016806723;50.251256281407;13.9470013947001];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;4.59144283;12.2107028];
x2_step1.gain = [0.0354831019441904;0.0354391208186784;0.0438105743716592];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.40954502390165753445;-0.70595576952237948376;0.0090660086568796240114;-0.30861312062796253386;-0.86388546499490848074;0.23961580794713785436;-0.17559706596016802505;3.0062246811538546609;-0.21091073567777185449;0.086088151660752718075];
IW1_1 = [-0.71242339156872602768 0.48573691312831929201 -0.74246529423708218509 -0.016670186150202187525 0.11658302660820993313 0.42020678996938426453 0.37933639797822432671 -0.11149362188933478746 0.68399026855474520659 -0.29290498718663315891 -0.16403581862366420352 -0.15522014475834397529 -0.0089712482934377509036 0.473409011641012345 0.63361913230056343682 0.062477098682612912384 0.23234110247285180706 -0.64133451047716938387 -0.065949731033554406801 -0.49407754079074889253 0.72153254451590786989 -0.844850723286773575 0.4956600681267505637 0.55518934020668120333 -1.1413903788260781891 0.37325051783892632118 0.73850801798780729701 0.19943599292526650868 -0.30471818950081458466 -0.45257700856277877088 -0.11692299529412264469 0.23236374745363533312;-0.71171347741654400476 -0.086897388362617344892 -0.53579034010755044459 0.71471511313397173559 0.61095453908463526194 -0.24654313034042973918 0.24950906350031459846 0.56318457740685023971 -0.19056113321600909316 -0.2737116972116809821 0.2196244762717040333 0.20535492522620163447 -0.50680154607186977955 -0.22624358456387988481 -0.49187022308472932997 -0.027396456530883146058 1.0319868956182318698 0.59822113086085348943 0.57610214044353635909 -0.14215328245013608699 -0.47153740918938008564 -0.1023466144544657036 -0.45327124467817120346 -0.59854337969763338201 0.32274531583774085375 0.034346029904288324919 -0.26702726803329979166 0.36895354073887154378 0.21656438480393855328 -0.28260704085493204563 0.26282823054675508168 0.0024534199805710311428;0.17578193890416402012 0.17571105611553902714 0.45063177201311044318 0.051584490936353408208 -0.14368194149944252258 -0.02979042496142059529 -0.045822556751250791141 0.33825648331399366109 -0.31596941118127153114 0.14733703591711599934 0.28251644085092442182 0.16986597012299373133 -0.10489590886716718132 -0.18240209718083233437 -0.05207302297082167658 0.094430746606322849002 -0.13869745021002771734 -0.12573061730342846576 -0.19452774469675540581 -0.00077275480948413050476 -0.1976030813213258408 0.29621209567083639502 -0.17854894735310683496 -0.3421352505123463339 0.46611864025141752643 -0.064810985671182791412 -0.27456706038785733126 -0.14136033645521398072 0.23588669276974208455 0.23291380510383058455 -0.21017365996955253427 -0.17078935272570613946;-0.019285679483278025254 -0.098691819135206623748 -0.4990763747902063896 0.73676537935632302467 0.62554364793517414078 -0.022058024875434234513 -0.30753261603995740714 -0.58800209676853099072 0.26869772179780893051 -0.5622006159245183099 -0.45436406198647660837 0.28110614183505699959 0.23478702458478320492 0.21995799833773463372 0.18535961024205957481 -0.25156625117908110179 0.4353305463529382191 0.39791847369749594465 0.40517359992960194637 -0.24541793589660731989 -0.8147477929567288335 -0.46120833686879925128 -0.13182542542694808407 0.029993789788302301774 -0.35853435160317975727 0.065909679784848504425 -0.072690790320253037549 0.31464006934815097472 -0.4622417061097424118 0.050979586267610434158 0.26555482074691710848 0.83161723812821342072;-0.05699339544405181146 -0.47169356015571123342 -0.50038252445149389303 -0.095641579788618175106 0.0372524295280514256 -0.20220755003140150619 0.47691203812048416077 0.75167252695870978574 -0.37034510007784510188 0.26735528443840267387 0.74431839041534308965 -0.036898048884708330164 -0.91264329179036485229 0.00041896369699207479387 0.0061354520477861392014 0.73485503973167243252 -0.46893606521905073503 -0.20553974514779582705 -0.031322723318300167705 -0.53243933280106181538 0.35371235649588161909 0.19424283265982300595 -0.31790735097944428089 -1.085557438786791673 -0.49669250753208021854 -0.59506150066127971865 0.22260665011968794325 0.1230487051764095896 0.72057619872261013949 -0.34919794523154507049 0.49382100578537302393 -1.091498593983063703;0.4083948730508232261 -0.1249341716098462951 0.016461015546950352045 0.33262253239528632998 0.2469826682711945276 -0.15458781128202503385 -0.17628481117475297557 -0.34734536647717068059 -0.14709959957723786617 -0.24351786081239132353 -0.10910737817668131333 0.2553855194822292618 -0.074518653083612385046 -0.011521887357079610426 -0.099575679479235873481 -0.30152073183531169498 -0.08594019651030289364 0.17151441501338593465 -0.010372324022364619311 -0.17738013654934822738 -0.48548366375147822271 0.024032551268389514693 -0.091210983955870975071 0.061274268927801925355 0.092103641706732020111 0.008888760854522375493 -0.21110730732604973681 0.00087884034729539901778 0.024289562618506031766 0.1881240882417071214 0.26775327773764284744 0.49736522227678137131;-0.15598115022259972928 0.013967868691958169186 -0.28261593515499133789 -0.064656531075961740096 0.09352263659784944283 -0.0046108965090987325333 0.089150212760509231491 -0.16415764781381705917 0.1296706592007050296 -0.10585838947962111778 -0.081043232801369408103 -0.037742728100620591414 -0.10445728409005777815 0.12805013057764980111 0.075667676969342206883 -0.090235984099766908262 0.040846465386988294044 -0.090519655321396108594 0.062133361374716519765 -0.069168929080573662849 0.15231533478855069363 -0.14624610016906597343 0.13094563534666806004 0.22773031109992564192 -0.31838146004983519655 0.067517182734515179821 0.17715070086301223928 0.050427701815914757755 0.021383324236308509647 -0.10861049550141677056 0.10873934012608267585 0.15242883326154302304;0.11710626043488239767 0.019267352715654072204 0.58598049776583760462 -0.28475080208900804823 1.2016887019523896374 -2.6382912373412441553 1.157254546254093297 -1.6721580623094625118 0.66755357752143085204 1.5527661687198903717 -0.65269252927893928184 0.60334593393809332618 1.3797653253944177631 -0.4818956287896115076 -0.42380247130269455003 0.43538052337705307471 -0.73813589892395881087 0.80065561432665444119 1.0231914780374176122 1.9223213680750035337 0.28446354505471593832 0.47111383141822815723 0.097749243713747727136 0.43381096132688662381 -0.66393284758496418085 -0.30527041817740191432 -0.045797130067026722844 -1.0085678657798631264 -0.35939760461923847545 0.53827442719091023182 1.1023885033356992658 1.6879377083163296103;-0.094075829875262084734 0.69560564479912068148 0.19731075758566046785 0.031912288215018624893 -0.28558180206727107331 0.55728722645691242121 -0.12200197069625658142 0.37010085054937691407 -0.12214388091530896385 -0.15904442683377184586 0.41837076837418840647 0.5507433065240254777 -0.28123885536823217679 -0.0823172108885144721 0.71678070125022941284 0.36118627091972571597 -0.023341919057755809719 -0.76832280947376774272 -0.49055860884568358582 -0.48896318503114227783 -0.0069467729470425922805 -0.48523418306505222697 0.16617712266140122201 -0.26747062024818241133 -0.22675064305496886452 -0.054521576096236881726 0.03335651435939609305 0.11618910152978174921 0.27377111260312236851 0.3425732332798905877 -0.38513511504818981335 -0.11554814845866695494;-0.46894699557750024743 1.1593790570250144256 -0.066718072737128042426 1.001984909347184427 -0.041223442189734449403 0.59136920559386341179 0.67067777394643757205 0.24255529407581097323 0.60159395920926750367 0.011422031571996860491 0.31023463019879571334 -0.17578610926066073894 -0.048461788025193214269 -0.54197519418006412373 0.12073828251433937897 -0.19371167540351816316 0.048082213114904202855 -1.375753064525963909 -0.68396538564983877517 -1.4871590885724241815 1.1292925881218813799 -0.85990992775014141181 0.24533964363899743444 0.4007521197576279226 -0.69669507583333911693 0.37580934054657200161 0.71578720825914199377 -0.062744507996513113057 -0.46285070721781784719 -0.039344579786803078603 -0.084114920417210872761 0.0052717143444125508234];
IW1_2 = [-0.96729498926443691076 0.17048310362982657673 0.016644679660299057516 1.5212340277941769351 -0.30642166607806609058 -0.090259467948975588558;-0.12111038433059805042 0.69939346126505197443 -0.15261450930426745387 0.88562773954478335448 -0.18142731609240583812 -1.5426502741456014078;0.56832739567400525349 -0.10032538646696823048 0.29016660915936676179 -0.43866787108196753087 0.53564526051721927935 -0.3169125214529683876;-0.45734158946981057214 0.68350705762842045576 -1.6457687658663988639 0.49208766074190668505 -1.2530756097586244202 0.33969947838331271406;-0.27091020860702585971 0.95384457759453500358 1.174338301956957098 1.7503522684263130849 -1.3639322365595087927 -0.53539404307834903562;-0.41874029037556209643 0.18675754817493639415 -0.97068267262128837825 0.21282891320011620984 -0.84194922274293226838 0.096662553965210853968;-0.20156318848342125172 0.19126025627493772885 -0.58624349002383302487 0.2389981904721240058 -0.36370761843773158351 0.32529713666701848274;3.441749605783919197 -1.6501044499366566143 -2.162345114251429834 -2.7551615495588883675 -1.7326263406718775961 1.0490365620141877123;-2.0099833267227609213 -0.38270464351291716421 2.1611129503879995539 2.0255414467874768292 0.26813096727190716129 -2.2119945077868057304;-1.0393563859065559907 1.5102192156448579485 0.11416560245963251752 1.9668332020372329971 -0.24947081475490973101 0.17288755564164454137];

% Layer 2
b2 = [-0.38620982571540102279;0.35443886621053999342;-1.2966767038842585968;2.0476150496338489937;-1.0510038615935111128;-1.6058439181506949378;0.16556100674926724214;-0.087318850755586013834;-0.14504241825611627337;-0.19237492789432858453];
LW2_1 = [0.79689476022180794068 1.0235942305174432487 0.093475540899543421713 -0.27913004455574397245 0.4722474960204565142 -0.20890746269538029711 -0.34477383021549284914 0.7245244363615044314 -1.3699638316593014675 -0.86098018746652482669;1.3162359979600808391 1.1795670882290323345 -0.32226913742588864098 -1.3174770362373269261 0.63235499181630694387 -1.0440379730760198651 0.086072377472098920981 0.57148464665877463098 -1.5018094551246945478 -2.0354220808322112113;-0.43853727403989234412 1.0329546392043285064 -0.48493909769153559219 -0.4346742271499809962 -0.27297168837163060529 -0.069151486098923659052 0.74905026273024044592 2.39778959213998899 1.0536119130753913709 0.090590824381267198717;0.12033384145765256557 0.67922226046483891171 -0.22079090615519553209 -0.74436656086959795964 0.39628287682992385799 -0.92226535315591029462 0.65090496850950518848 -0.80995137365837055476 -1.2687886023431020899 -1.3057644488808815009;0.18023968554554856136 0.58598954879780340566 -0.29227209248149232934 -0.31372824220188805233 -0.18186177712891476999 -0.52891303712430304262 -0.52729229479107497802 1.273784160817774902 0.93535454228061232218 -0.19564288840297883176;0.38845115654418954643 0.70904539869518190542 0.419019810529582315 -0.60121129695439790019 0.684652708147092115 0.59784850988794746574 -0.50182778534205019216 1.3668406759780706849 -1.9544245890958613643 -0.31984466445816339686;-0.78100994423275027501 -0.59215765888335925027 0.74113229664630131399 0.77158142708464028114 0.10618606507590573618 0.2674627945347174407 0.73638319547254205144 -0.014261424741892720844 -0.79937250882093424664 0.71662727727306418934;-0.10048667332373031891 -0.13721885401995284615 0.6527917833601268871 -0.20043662514841301125 -0.14527642761622025502 0.32055800175238008398 0.72411289774204945502 0.055446153673679388074 0.47183976268250477082 0.22123324005697159178;0.32188361620329397628 0.90977299642683107095 -0.41423441302065072689 -0.64418701435472525141 -0.31222050475849988382 0.41471768670610476004 0.27325410951989570485 0.84117272774884088715 1.3776308931266278979 -0.10152717108029125914;-0.52945433384520435016 -1.6905868330374578257 0.8107796861223119933 0.45551247022344371063 0.26297988463857918662 1.1584707119076538273 -1.5646285769314451919 -1.4405212181320081744 -1.3621432976785081692 1.0552627671064054304];

% Layer 3
b3 = [0.42114188118621043166;-0.035010070095052740757;0.34828280340344847099];
LW3_2 = [1.5729344544940169204 1.0907410080011965547 -1.9941187908179280885 -1.7820573506433363686 1.4015951705624321022 -0.30623365552632186848 0.68680554847543917596 0.71268748595786690636 1.4722744986602966932 0.56246437332422549726;-1.7874193618334417444 -0.79465953363228947204 -0.63686065047288142882 1.38812009767575395 1.4855217511111640238 0.87968070566743628014 2.158800735368647139 -0.095410518959636286818 -0.78789877654606710333 -1.5807089302504437889;-0.49431864051618129574 0.20660232866883365688 -0.81028330301988571449 -0.29053653435668336247 1.4027951064266075409 0.28030739827060185965 0.26161756978122052697 -1.5620601555360542623 0.52206459657603521141 0.23313727690340838028];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0354391208186784;0.0438105743716592];
y1_step1.xoffset = [-4.60253906;4.59144283;12.2107028];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
