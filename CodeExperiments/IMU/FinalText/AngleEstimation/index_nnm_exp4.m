function [y1,xf1,xf2] = index_nnm_exp4(x1,x2,xi1,xi2)
%INDEX_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 07:22:24.
% 
% [y1,xf1,xf2] = index_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.2493;-0.1472;0.7933;0.3099;-0.1999;0.1149;0.7926;0.0706;-0.3634;-0.0568;0.8731;-0.3286;-0.1469;-0.0325;0.8804;0.1802];
x1_step1.gain = [5.88408355398647;10.482180293501;13.5135135135135;7.36377025036819;6.47878198898607;7.68935024990388;11.2549240292628;4.41793682350342;3.94788787998421;4.35445242760723;15.785319652723;2.87976961843053;8.22706705059646;11.4285714285714;21.2089077412513;7.6219512195122];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-37.58893822;-56.51672659;-19.90957524];
x2_step1.gain = [0.0203652161747678;0.0399559081207787;0.0383263708961283];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.15833979288110563988;0.44030057405658673542;-0.23963110598077216884;0.67824585351777888498;0.37690110372835244901;-0.059742451166266745399;-0.40752585042844780006;-2.2597155739963334931;-0.41361872544164307586;-0.84656834676480252622];
IW1_1 = [0.34123644819700515995 0.20828101680773922211 -0.30527831873849209376 -0.072037826990078879241 0.090835300514600633703 -0.037039333600551276049 -0.038985620847753317542 -0.16187071860864907236 0.13398369032346890695 -0.07243871628915865557 -0.11381057073317442374 -0.10089021268752139393 -0.58289122935650139468 -0.15364847763938332958 -0.054703747370765325175 -0.045606902506168965628 -0.078218903184946272922 -0.11979462625659254016 0.15147528106009541804 -0.052628785590653953674 -0.11577039415482116846 -0.034733959842923926853 0.20827359909856904552 0.30797064857790162895 -0.086908711597624338507 0.011408042368377653217 0.094887983807162915029 -0.0088423847151503330577 0.14548463406649200791 0.21260154132604222599 0.19449237411498027095 0.30494237331603624153;-0.59893629122578795343 -0.32466507503719854721 0.56133305304570879635 -0.26779269649007286791 -0.30587039709105778851 -0.018889712660536989164 -0.45342420399801480757 0.15587405142827467919 0.15252196207815296725 0.12604715544686770357 0.40300668635113429117 0.28273329066438551704 1.2921024903901427994 0.07478842070706478995 -0.26597079180449267888 -0.13013367170554837604 0.14170420895912747006 0.14771186250272111407 -0.15838062045049655646 0.39054149225160250669 0.26291871008396427989 -0.15099446480830600037 -0.57433721125910652816 -1.0962876524374505216 0.23240455739154997072 0.20674020096536591118 -0.29260140519884775268 0.21315810447094354907 -0.17840818036496525201 -0.34272344010474337095 -0.4420434787295953738 -0.56562418517534329698;-0.82421241765934649681 -0.77394517824627340197 0.5640679519418079213 0.33169481397857641936 -0.23368368503910891265 -0.062322296642104188513 0.32159936886817447332 0.077701921813803212502 -0.31254393864359741873 0.57149845789274222874 -0.030048761097625008992 -0.0068445680557777275818 0.83589933759377765821 0.56846680024290319189 -0.35422256349553765675 -0.12836752937792450524 0.10408334454376598488 0.57385696599347568725 0.41508911887595822954 0.68224306887930685761 0.30017006204255169965 0.52930986506390897972 -0.31944495850087328837 0.079570571492776617784 -0.16992413707865730577 -0.68998060875086286714 -0.025158266710936457583 -0.014286112596560871998 -0.25199243565641177289 -0.95006828160986966925 -0.10363792551838578448 -0.62522518256812653625;-0.15932501092350784266 -0.39542916519231319228 0.34117685938405523105 -0.89135599503515872133 -0.5267816534512057558 -0.17234970609143529519 0.77122207625529271002 0.1392156118696294409 -0.47104315140233293802 0.46168175239142394961 0.14817971131874826951 0.24404736657310852066 0.34887053478038881904 -1.6912265083521877962 -0.87921379467878446601 0.32755776463102614926 -0.75639907462071309663 -0.49147867143907242315 -0.45802641762229862055 0.23581411605819857513 1.2685684475256433501 0.018069715249641189747 -0.49889151548826626836 -0.1593221608007676926 0.14018312973631316676 0.74945627814121895671 0.30359718440995098199 -0.76687613048067315713 0.91473987421248759144 1.3914476222949281325 -0.19763993488592973558 -1.0023665586273462491;-0.37725595409791701229 0.35469927299039644142 0.17948946606563884187 -0.067444403219408408101 -0.42524151043622165913 0.50310825944798487352 0.58071521763634803559 1.0371031745133165725 0.011580184211399941266 -0.84382205355457073903 -0.51828341085281892653 0.074844879607403408395 0.33796318914440376391 -0.82284428810060017412 0.20129959242973996525 -0.27352402428833777481 -0.80431008012443816479 -0.63924558418693711026 0.15312265069941169426 0.84428167949555699145 0.5695625793897002298 -0.46854932690539757845 -0.26859339484641608919 -0.31897406150593643481 -1.0654565015842334397 0.70576654048519005258 0.34291535156566516074 -0.60929446453558844254 0.3537488888649953922 0.98182452723812752016 0.62504065194964519847 0.47155485115653944517;-0.78658593577863344937 -0.87782175406631235415 -0.1045982929705947112 0.72736248923365542929 0.48326722755387702124 0.40008664797817361514 -0.49233671419005414771 0.44819147890200061735 -0.62578998894800796915 -0.41626160679786555763 -0.29416896439715489731 -0.41664887179589715771 -0.24830265031197254477 0.32249586152310649734 0.48666618121609334091 0.69075466463811241447 -0.0034314933556721101231 0.69729015641185254637 0.11391251307112788826 -0.14659003990916519289 -0.53129202811170272991 -0.49345756910835714137 0.34842998255260970719 0.018268913214327327926 -0.76579842426839173086 -0.15648543778579404595 -0.037271539660850526443 0.2618506824436470648 0.40674710268238378763 -0.086783048957096806109 0.49972693389393241237 -0.30947510795557509056;-0.15682088922909465101 -0.15634056800236229012 -0.106194442024037633 -0.30149366477497768768 -0.0040888212488299682107 0.1477161559797764423 0.02003516462819456001 0.27939115645196610505 0.25526323973218945085 -0.21386021218117351461 0.067695623743801058847 0.20282512238579439301 0.40780055276482662929 0.45008601272063764043 -0.29499427635670483205 -0.26894977646399575999 0.075167028461693999319 0.15949976431641221808 0.3648872220210124806 0.45717368429935606455 -0.010977783409896028216 -0.10750971612275182776 -0.13315731603889885415 -0.41525230588966055567 -0.062828593864954790371 0.30848226138724837986 0.018244047777653302211 -0.0037308594177684803982 -0.12945078997443124069 -0.64571904759460985179 -0.10346126345848506711 -0.047755454612264706948;0.035336434924077092523 0.40706073958576921568 -0.030833599225582448283 0.078505561018980582477 -0.45877932026240964003 0.26464956034321829303 0.59242518227447626966 -0.34000891205791988758 0.3826948119697722861 -0.80982551184934925548 -0.24164455404966253549 0.78264132251844931165 -1.1552265843577409488 0.23951349674279512336 0.43099833557854327903 -0.83540456202378055028 -0.071518792661053112725 -0.017521016737683185738 0.29806458009104952467 0.44242839141371126388 0.07086131575770152069 -0.097526838275420010826 -0.10196129022876156134 0.2023121848108633547 -0.38507494796609148535 0.94123749496265496362 0.7880792924513990716 -0.89532026317244495228 0.71257435834489546433 -0.38623515622395121483 -0.52274786458027189262 0.60663660584635314965;0.3985624892317821133 -0.0034288595144503037845 -0.089337781208164809832 0.27173372839937143253 -0.064068546989478017406 0.018683615631918112227 0.58035813231549537861 -0.23224499875589829645 -0.2287532280995349665 0.18733836639618881015 -0.30911261389740224415 -0.087567771790845294611 -0.8451187564358368931 -0.029589156700252829818 0.11736550427685991937 0.22676905670144281713 -0.30364092818085736125 0.01524056760126303936 0.39962237968221514528 0.14558225533248467243 0.20761416299430124344 0.35118362590263291212 0.17865620382892768991 0.91958025630616191393 -0.18832904241264683542 -0.35857594595912573032 0.31991608338350774332 -0.26300426712076063751 0.18227333231554052051 -0.059255687285148697652 -0.051930666055490612432 -0.17020205615196609683;-0.96453298495670514168 0.3119166933324555302 0.18443756709681347061 0.94189057539458043156 -0.50483643925724608348 0.26491548635770856279 0.24442089064055172454 0.72972866617131582068 0.3084923614748620313 -0.86807545523629114914 -0.63384137290469377835 0.43040925797567547439 0.48361456941731428838 0.6460871263750462834 1.1437836634598201879 0.30500542284288695294 0.4014282244177334591 0.072363382499660428016 0.53749973833109887522 0.59472498682768548672 0.34702726304152015091 0.11270325189313204484 -0.16653701784454044699 -0.074028579835022298439 -1.0199540077700177676 -0.069838170928852208452 0.27401153770373803953 -0.12147050488437897975 -0.82767434555810970309 -0.54147493435425886332 0.51876221715685499891 0.5361973596029248057];
IW1_2 = [0.25521972605924531097 0.65217325323449337748 0.49168496606220668532 0.093682181414039902845 -0.36877146108044439599 -0.088276324267828498726;-0.18841325771449943249 0.27285307349438103763 -0.30193067620387703531 -0.41114635249179559695 0.70540991257751728405 0.36726271818781286438;1.7383106012886380132 -0.72258460267726387638 1.7398967644361784668 -1.4720795466455054434 0.51894276424621310628 -1.3435578987807035301;0.91333989309020746639 0.23001887151205724358 0.14241144563188132266 -0.8994080059543588801 0.86946605547706212747 0.96124988512540487928;0.94763887415175673823 -0.32002221823295678993 0.6091209489169718827 0.20744658819620090395 -0.72653075400823230456 0.48610011087832638577;1.2685567841689822099 -1.0928794936629222523 -2.094951357296536365 -1.2504526790513057488 -0.91910308540724106052 1.8574200179015367684;-1.9369924821561224082 0.83234106304990884695 0.42878950998356396562 0.84533984009058504849 -0.45922842181564549335 -0.23384860545679383992;1.427015377575214794 0.69707988295701606152 0.58027175214235116041 1.6349671136063930188 -1.3010764055591659272 -0.91085835664836556358;0.47425758163573200621 0.35349178350127163917 0.67789962659646307852 -0.13533447693416156277 -0.23802558030614240359 -0.95598974666726910243;0.3839682077556398343 0.11723386534248669832 0.3925041977141145999 0.062934881917586796285 -0.92146186127846352321 -1.3046411851373060919];

% Layer 2
b2 = [-0.151224856320425316;0.23362884972578715215;0.43296622924744004868;0.75845266257939614185;-0.42261679175521937868;1.5584512936082204337;-2.8618664603739407681;0.5071105227866450349;0.22245515374248059359;0.66953361150402723734];
LW2_1 = [-0.24888067597850524471 1.6243415691985361171 0.63351621992953432994 -1.5220964957215941116 0.12007069125601706194 0.74136685075986008542 0.65843051946058062107 -0.57624375525848536839 0.036281515517336521137 0.4835501480406866337;-0.58074706169041245829 0.04843912208968338684 -1.2629914656699254838 0.053882948155693867476 0.50031925895268636317 -0.53154889184629439125 0.92281093329441310491 0.6516133039633836832 0.019178261937974179496 0.53828324453184095422;0.16642127410138518595 0.44881192992511070861 0.69155104971747793918 -0.094799899691612177222 -0.42821554406761797029 0.71217955742631322558 -0.91396869236459687968 1.4921926733311814406 0.44433066750815808366 -0.39200371989244908733;0.76405767333437302202 0.46219253474087057532 -1.9613011228542822639 0.51577062977383791864 -0.48232450209014793296 2.2522161430494080925 0.21953624798247903249 1.0351281147031632379 0.096681031715833254392 -0.34059449868957786256;0.10899645044072150957 0.149949706556343626 -0.18729698701412292317 0.1136129475894936125 -0.33922060244471263779 0.26306655175159998628 0.085004835387832461402 -0.4064122827406387306 0.089838599612293124075 0.40583834915876099148;0.39862766569527630089 0.3847014583230385365 0.62783387789121003486 0.14123121522115536508 -0.87882135505017811017 0.71287235159521145089 0.33442641772395531596 0.028696761357187808295 -0.8018361266371772933 0.64262807467496152469;-1.1804664783015050844 1.9810922705745332983 -0.63874584492838615279 -2.3500778844536291956 2.5148841796203944554 -0.51694049354761362203 -0.88203754855432658921 -0.39880505133040178301 2.7066619194265131298 -2.4602812682043895265;0.76331184477912883413 1.2037394620817081226 -1.8093231614575981947 0.32962208275612803199 -0.32279034512339893626 1.9994532687825867789 -0.082830588636122526314 0.86582951989284162586 0.49952155440266321484 -0.4795217221634043292;-1.003202771221222811 0.021292072312695819319 -0.24962691767197597859 -0.1334622935081912487 0.035177304254889241175 0.087416549010072466808 -0.14348271149199606778 -0.073846259680046877349 0.26230163720193261367 -0.10028884485391541259;-0.110951132894032925 -0.9809842915055315693 0.1569313620824843436 0.80355388026491236797 -0.33258551350294435212 0.0035405454931152699483 -0.18731738068955991472 0.56551040926789097885 0.25093395898732157034 -0.49876141428541836964];

% Layer 3
b3 = [-1.0869254526955465234;1.6287718347375346184;0.25151179953240759835];
LW3_2 = [-0.85215766829291361706 -0.73547249485479937459 0.703448382247598758 -0.16586689682316263506 -0.55001759357260748828 -1.2073753169362686499 -2.3230049196059514571 0.3156528904624484877 0.5426844599037710104 -1.9104595186591193379;-0.012174243548294163067 0.38847320488452369291 0.1688399642649986987 -0.65758365617713843143 1.6331049544093589887 -0.237749613378067437 0.96423521988640570335 0.78513145897136138451 -0.81638893781032606523 0.30697663226494714683;0.39695676135719321076 0.034467565195022642488 -0.41263762038808488031 0.59078975359517582611 -0.51589949637333232246 0.74424819669168496006 1.0622136109695110573 -0.7847982865536992092 -1.2803314372730529858 0.69042036414022656121];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0203652161747678;0.0399559081207787;0.0383263708961283];
y1_step1.xoffset = [-37.58893822;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
