function [y1,xf1,xf2] = middle_bm_nnm_exp5(x1,x2,xi1,xi2)
%MIDDLE_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 14:33:58.
% 
% [y1,xf1,xf2] = middle_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 4xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 4x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 4x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.409771644189748;-0.338406207201333;-0.203058649071918;-0.16419875262578];
x1_step1.gain = [2.27990427281999;3.24512785081417;4.34636578207219;6.30741808504808];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.05729511;-56.20691974;-10.00403908];
x2_step1.gain = [0.0211267846895733;0.0395706711489379;0.0871775967713017];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.85046883708640630406;-0.1690456773039059335;-4.0821577701321114517;0.20879294859216512847;-1.8488128243291115371;0.44427788975016568873];
IW1_1 = [-0.40856494303084894826 -1.1501658761936039976 -1.3547215845458904226 0.44341076577438631734 -0.091582068869746152684 1.3091163791607478561 1.3412664236555431607 -0.27176540961877498903;0.048051577955902535777 -0.085839062602203572427 -0.010350640008583107676 -0.15586336547753906756 0.038855435721927747417 0.27066824105377984555 0.07282517566596909131 0.1204682354408424666;1.290393787590036645 -1.673820132534490579 -3.6823918445709744596 -3.3589491367392336763 3.6274695557889589104 -0.71226456680382932429 4.8798669397713094753 2.6266537423207427793;0.0026563719288749021614 -0.028223328137187232711 -0.0017483538776342855744 0.0063456227756260750669 0.00035539702693670598447 -0.010078723292469452671 -0.012579651601297840366 0.0026295371760127286311;-0.70071672758172376394 2.3783209492998724777 1.8366367851906493236 0.18710617664976572638 0.57579896206656433488 -0.43706528413498646479 -0.81435361095005220911 -0.50762537751616532145;-0.018419063780912230122 -0.14314596527555251138 -0.023919712925341580362 -0.060666210929645372762 0.00041033713008762506434 0.090358751435913528538 0.0056752372031844966482 0.064645595948713455159];
IW1_2 = [2.8402730986552278125 0.04172083079067476219 -0.12610439934869430156 -2.6069853718882760596 0.40002834298295392168 -0.21281494768530201389;-0.14298111619242773185 -0.16011355932600965235 1.3510353387760352106 -0.15650373684251125961 0.34622626590417937553 -0.62700557612847518385;-0.081029038822652069141 1.1515534817478434437 -0.14019007088081142376 -0.70996158840479905994 -2.4166311833985205659 -1.3945197650426204294;-0.58515198555911895895 0.011606370431527037596 -0.027721990384563074267 0.22089809085798597921 -0.053843517748686946234 -0.013044580560796738972;1.0273676219628795625 1.4861920637067145279 1.2412460060700343245 0.20040119090628602527 -0.35408917845630105692 -0.99103840239163298875;0.0033676068709827130208 0.38858232324066288577 0.029616708193255836951 -0.015213988995754969269 -0.15959026455655589416 0.02907792763690790136];

% Layer 2
b2 = [-1.3133930229204910933;-0.0039645064751727392832;0.62531914549158507111;-1.034737227861551867;-0.075279087983308068388;1.3856617867093290464;-1.2096190112126594673;-2.6401104672770165926];
LW2_1 = [0.31398578239554697511 -0.12536166816055613338 -2.0259028441759125982 1.7025931066247128598 1.0708910659650463515 -0.84870880673740267675;1.0641360768523149272 -0.33934035353380587186 2.3868475344820740958 -0.291052642396044281 -0.54345153748147845274 0.42234989165363912011;-0.1353198828026695999 0.51430028833450447401 0.15435463919295777657 -0.28292056513972391185 -0.0613738197871220581 -0.016118657768743556435;0.098342187692204721672 0.099409836956669758723 0.038152104345797188678 -0.29132916023908950187 -0.16406650958716428867 1.2266738077124450523;-0.68898537106223312065 -0.76049276497320550394 -0.11043053908967336019 1.7103424679865775193 0.85157557408142248168 2.0468036309396548944;-0.22656884004292693335 0.20017087877602912638 3.2708266415507996072 -2.6231635157114432388 -2.5792504531460109796 0.58283099405932659032;2.573988489329925855 0.011410872210942389279 2.6877050108048918808 -0.80462960706574049308 -0.63487139272308601434 0.64434604180149912533;4.2573242475742469892 0.39639475439771537646 2.8939546976034939973 -2.0258627935641295714 -0.94152841406750897857 0.53999795668169925378];

% Layer 3
b3 = [0.096601217345464632236;1.1596524355084050217;-0.42573699968113859482];
LW3_2 = [-3.7843390522674575926 -2.8868502066094956504 -2.6887765548832258666 -0.38506632339814711452 -1.0475299170433827189 -1.7125000814987192399 3.9105787687286013288 -1.7855703133310638631;-0.43081555517555136792 -0.47664468418069305677 -0.57491356689885042552 2.8612079135099111049 0.45076316911221986361 -0.19823104611603187264 0.67479546027249237561 -0.32880692213343448715;-0.027823887482320674991 -0.20255996150195931804 2.2003197470526281165 0.90111575479972572111 -0.15679472033905214601 -0.11156645122432685968 0.37181752841509951857 -0.37250599066111511615];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0211267846895733;0.0395706711489379;0.0871775967713017];
y1_step1.xoffset = [-34.05729511;-56.20691974;-10.00403908];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(4,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),8,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
