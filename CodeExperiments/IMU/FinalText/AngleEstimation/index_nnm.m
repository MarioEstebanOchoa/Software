function [y1,xf1,xf2] = index_nnm(x1,x2,xi1,xi2)
%INDEX_NNM neural network simulation function.
%
% Auto-generated by MATLAB, 19-Sep-2019 17:20:44.
% 
% [y1,xf1,xf2] = index_nnm(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 6xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 6x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 6x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-33.7406296948085;-57.1221176756341;-19.7284169437486;-33.7618349904975;-57.8590179250591;-19.3952408506384];
x1_step1.gain = [0.0206602845294696;0.0415964149107798;0.0449097649882465;0.0210934199245808;0.0416736727331636;0.0465066896592033];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];
x2_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.24633721201948247104;-0.045907977084380741095;0.41207981237539498265;0.62288642792265647152;0.12866993020954425875;-0.01601526042982545639;-0.14065100358683235715;0.025985776135122345964;1.205867979695885106;0.098383799988977213569];
IW1_1 = [0.51978758368315547411 1.0548609991371642458 0.010029568014212541724 -0.85350819929830645805 -1.2291070785184894376 -0.4620843259102870304 0.20165294500421199198 -0.44539369515274390698 -0.87127697330381415064 -1.098356906156032986 -0.72815909921193133769 -0.54904422470866920403;-0.19197298979884111492 -0.33654796499658545805 -0.25936839952143564414 0.052031269617832123786 0.12084595358116864694 0.24405570638330115196 0.24928646076880459082 0.38604680965743426446 0.15512552170107998806 -0.19511282389321865649 0.56729763832535806678 0.17372192938589856026;0.068825246971874753932 -0.37713787635112250296 -0.22317051331626702737 0.64183658523805442453 -0.15848888816406167535 0.29607390745001105348 0.8291213808676121122 -1.0776621040738818547 0.18487443323909633075 -1.1319424708600358542 0.74509730872754098563 -0.23536023815237558376;2.4368527844232685808 0.10786922820037918302 -0.679553941946085871 -1.5726493463663127059 -0.11923205832896088818 0.73281501384627589779 1.3199425810568070627 -0.89773960353835757786 0.091188005165566174415 -0.91263135680816032114 0.42391234237295571941 -0.18908649926166060107;-0.59917795437756227184 0.18904667368349969969 -0.65494275033115434415 0.37001342343941762136 -0.91305135534907977402 0.049058122252498712057 0.26669417322570282414 0.24122923200932722132 0.070735617036574605088 -0.70486149686095966871 0.090021232105493134701 -0.34009954863198504915;-1.0282706308575524368 -0.071877467332862488014 -0.42378927907954427878 -0.73975928367670262809 -1.4423953507271882746 -0.65447873753298035915 -0.45369387144368156228 1.3512192446123694189 0.67163551556292089284 0.49281859061243515896 -0.93521535163296498627 -0.30972339806221693692;0.76323715842585160285 -0.059106768479838950325 -0.12933424586957320557 -0.94724263874188119328 -0.26743710802307352203 -0.14951857407170746073 -0.018200556554967450146 1.589829308677267683 0.52625301820866543512 0.85125875218750579609 0.52836816166310318632 0.50501788367021716031;0.81125449355767498272 0.83677109141652639135 -0.079154673872117137234 -0.094878563707926397153 -0.62306442315700827361 0.18165533114426005157 -0.0040112314616827446367 0.47707058582697120519 0.37645159334349365121 0.37069579424064752482 -0.66075730990778180907 -0.38438488275370769065;-4.2535793266326509254 0.043092443890238245341 1.37102417376154051 2.3880460302256234506 0.078960676472802790449 -1.4608086452161876956 -1.9945973121509084081 0.84689048666797284159 -0.37419450059745440473 1.5515602080619501635 -0.66095270334366840181 0.50790330743043787809;-0.22103467615884547781 0.8570931253239401082 0.79866314052874409768 1.0081612835111080084 -0.55641412554147628988 -0.46379964752708768838 -1.1264366731188701909 2.0041101582349925003 1.0859156491233059594 2.3427469975388275358 -0.5083217037106807501 0.21953384462373110031];
IW1_2 = [0.90368508386555057577 1.5040594570738237135 1.4165281068882948912 -0.35180216595564228754 0.047267746386919440305 -0.31555890580885836982;1.0622653453547565849 -0.12462679950541936946 0.17312769793990578915 -0.88317997576234985591 -0.42424243092349317452 -0.25269880416201639939;-0.8212931853914833269 -1.7425078561251585718 -1.2989780341621279813 0.092473905472163428487 2.6229905074636001849 0.93486726819507515174;0.79172863982771946034 -0.032576158758836896989 0.67090327140991179444 -0.96050396652595815272 0.40440727884543897774 -0.9067971891572704779;1.8033950154539539756 -0.98341591427486807486 0.76740973906268317162 -1.1771325661519826955 1.2942902982499677744 0.21160928071522264182;3.1064811245040648835 1.0257574305146259785 -3.3453663076363873152 -1.2185867631021143342 -0.56211931409676740845 3.7666611051889140604;0.73930168305273036289 -0.17618511186501753518 -0.4103735704953839214 -1.1693933368508293569 -1.8770036593385721613 -0.71685519158936938933;0.0914870739794984289 0.0099784046241204148175 0.90280869602866198331 -0.54934970824065587625 0.074654115318238414845 -0.82579182758681768384;-0.74054873765718620682 0.40539413736576795921 -0.88566979819993074674 1.1020175657352424547 -0.50230433235062466046 1.4156606632306758531;-1.2315572689878950818 -1.3572142238053321872 -1.0510175380072965812 -0.23782773052436903538 -0.53327261932297598257 -0.56459766577460523962];

% Layer 2
b2 = [-0.00511335702122413336;0.16558396062673425009;-0.062559580940576814401];
LW2_1 = [0.62133751237798207079 1.3829468891967144906 -1.3512048544627768276 1.7974687417188937033 0.66284675020739614038 0.25633194094597439028 -2.0260775751504001008 -2.9549135151635179675 -0.86419866743037498935 1.9147356534095316682;1.0157111620750736147 3.1880239899004778614 0.39147889242205319293 0.11841228116695771966 -1.902873491623931379 0.22755695362275582538 -0.96942687743582189874 0.19430454560380872042 -0.014398727616088825842 0.7252245968737200954;-1.105547438812486849 -1.0894014383366545928 0.29671267291988950854 -1.1904375838136860288 0.3181468498646540799 -0.32865612686040795998 1.2168567705637773901 2.5694444857692433359 0.59576979817326236599 -1.7461970846879433239];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
y1_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(6,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),12,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
