function [y1,xf1,xf2] = thumb_bm_nnm_exp5(x1,x2,xi1,xi2)
%THUMB_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 14:37:38.
% 
% [y1,xf1,xf2] = thumb_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 4xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 4x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 4x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.272484189700909;-0.21676763725856;-0.180517740526315;-0.162560619199683];
x1_step1.gain = [3.00685442929844;3.19703941041068;4.74195484082141;7.50272416774596];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;8.007185151;25.69303831];
x2_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.017751341197266533312;-0.49141596759001160422;0.92592680847808950251;-0.83749302630597932673;0.113077429949969957;-0.12516318043442453689;0.88268719245053106626];
IW1_1 = [0.45078825432186553357 0.62937773579840183835 -0.079768780674248043749 0.1651695845080537739 -0.47629009204796912691 -0.68701153068645792743 0.23978894804234524019 -0.11595694360362784892;0.55592319266479406359 -0.93400532960789228731 0.0037456056488321593824 0.6522037411151467845 -0.25885950772177546142 0.93872652847662718667 -0.1328541525095862097 -0.73493110041631837248;0.46153488557289584771 0.12681047707444259576 -0.99614828121018361706 0.097047002323199946239 -0.68469101475941351875 -0.74545809011229091645 -0.051734160122180558594 -0.050480440604852155895;0.84057768360844598021 -0.10143182159426981925 -1.2000571711127276942 0.41140219899456442754 -0.79289346960987705515 -0.56457733081842431666 -0.12534849168297543254 -0.043595869240727599947;0.45116221597299299706 -0.059475192494354178763 -0.33073032603062890722 0.44583171329910448177 -0.45396488451906114037 -0.0028558555441206808292 0.10998110180047107609 -0.32078658057119641134;0.22669262753210112082 0.041683483306702774629 -0.19941992567286839777 0.16642256285176318387 -0.25719880279289986102 -0.084458427214281830975 0.12366243975897119045 -0.10732670250954218227;0.13262137783393093682 0.76752126860034330935 0.47831685466600193379 -0.081236020061399613623 -0.068997801440403710993 -0.58966662753848386735 0.27435276480897058393 -0.082831441582292081316];
IW1_2 = [-0.51856558746472691812 -0.29761942164478488726 -0.36138472595076920335 0.42637044157093634267 -0.24189346943838974102 0.64567501465503451819;2.461723150265163973 0.56239109006182308459 -0.85090456449001150574 -2.4066708208903189181 0.20020307578986082375 0.76913676037723677226;2.7871315027318535051 -1.9106134808267107861 0.067374748973766815374 -1.0515493253248728855 2.0596462480648591864 -0.55182578582171937231;0.37894264342466510431 1.9651218473437204182 1.0944109765940119861 1.0531083765189055423 -0.82360914954989217218 -1.3456985125547809012;0.17471331147382210269 -0.19435530891199936931 -0.23920155927876923796 -0.38852261211619443237 -0.13185792268816640127 0.26654605397465147565;0.30795971876193523054 0.13146209388434459964 -0.48304726809332176884 -0.10315533237088216068 -0.26720088153101390072 0.22428428362975735832;-0.55822937918735338059 -0.17233053462260394806 -1.5365890613129422615 -0.16040406606633283992 -0.098625476664923203418 1.6259281671707543904];

% Layer 2
b2 = [-0.97485528743198879287;0.47081528957053908613;1.4042074630503493804;0.059815938075116953376;-0.26484746991779112291;-0.95120876421145961199;1.0221315034263169785;1.9513645272844846179;1.2279835185470187042;0.46667637390045374479];
LW2_1 = [-0.86962650120245454932 -0.72534306624964417498 0.027409612541880328668 0.2921010116526903122 0.25998141917718292637 0.60601656472032983114 0.86057478254165187259;0.54540099168087630144 0.063337231281285460982 -0.45141678834916598717 0.19617692153481319783 -0.34813800633583408262 0.59367151989300093184 1.1299775065640129679;0.53540297462762431735 0.085358841888742181814 -0.66269276561462719943 -0.29414971479080465055 -0.55211118251484769814 0.80035458775020162925 -1.2913030935766249829;0.49819308354417679574 -0.029926931462555570601 1.0064913039502285663 0.21323799100182141975 -1.3896040226966821507 0.45568775973791803002 -1.1365358870226567323;0.48006695548428240938 -0.78511805875589812942 0.042240690384658934053 -0.3360346011594465554 0.46531573833605671675 -0.14765275394329704928 -0.25299110407640412745;-0.14802255940809955215 -1.5085213765453613366 1.0462888806803718467 -0.11861942551892649955 0.373877551824191523 0.04557372711076276145 0.15312422253673435568;0.80069502917451218504 -1.7899344602813493932 -1.5911583429027156278 -0.13440512330836545951 0.15907635766168734537 0.85852111106752193592 -0.77983852387484808855;0.67670299499443042901 0.282655481348622728 -1.4355465524641726205 -0.80078966724606337468 -0.2761202176773259187 0.77665622574728088168 -0.86678836681980819812;0.33664559333713006684 0.47792513645709056025 -1.254185505351629315 0.5585247326016553604 -0.72580210099290509707 1.4140943811661281782 0.70194147812692730959;-0.41546566353023434148 -1.0514146395753565244 -1.2081712895667671148 0.11963627076145465222 0.46833527560940879653 -0.61020707206004698442 0.14496810575556712264];

% Layer 3
b3 = [-1.2666708876993102439;0.77113382095778204572;-1.3014374112882121093];
LW3_2 = [-1.2173427264489138366 1.0612589488837815832 0.75405324424005948369 0.14139611464332454971 -2.1202079667042910138 1.2753712225364923771 0.67053484090610171453 0.30233840803185557666 -0.4079170132526843684 -0.71410952483846557026;-0.11690465244324316219 -2.3514833518053932515 -4.6015215404778579966 1.5898827062107656616 0.54818252213692209018 -0.15461749322081830282 -0.17454626221057645274 1.970409962100898138 1.8205973545685263382 0.80882675478459065133;-2.9977858737534162081 0.5562128327450767129 -0.74986074367671262664 0.40184325119977487573 -0.94008332391085713819 0.71542479005977388518 0.34456233586286177939 -0.19577641524347810797 -0.10263750057185878906 0.94399352457177676534];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
y1_step1.xoffset = [-4.60253906;8.007185151;25.69303831];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(4,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),8,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
