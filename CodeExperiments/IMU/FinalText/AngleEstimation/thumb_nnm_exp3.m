function [y1,xf1,xf2] = thumb_nnm_exp3(x1,x2,xi1,xi2)
%THUMB_NNM_EXP3 neural network simulation function.
%
% Auto-generated by MATLAB, 27-Aug-2019 19:10:24.
% 
% [y1,xf1,xf2] = thumb_nnm_exp3(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.1659;-0.1251;0.8816;0.0693;0.2291;-0.1934;0.7599;0.1397;-0.7748;-0.1929;0.57;0.0952;0.0206;-0.0416;0.9459;0.082];
x1_step1.gain = [8.058017727639;5.86682311528307;25.706940874036;7.71902740254728;6.52741514360313;5.92592592592593;11.1731843575419;5.29941706412295;5.14535631592488;5.22875816993464;8.48896434634974;4.64252553389044;7.5046904315197;10.5042016806723;50.251256281407;13.9470013947001];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;4.59144283;12.2107028];
x2_step1.gain = [0.0354831019441904;0.0354391208186784;0.0438105743716592];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.55124741868504234521;-0.21899026659193057687;3.0172777513240363056;-0.25920838849074578913;-0.9788466567456118872;0.55876464274630766038;0.27400242307940786413;-0.36308236721162784333;0.40353196812680713901;-1.439910246578903763];
IW1_1 = [-0.18811545087472980597 -0.52776932006266052966 -0.34495415224836117885 -0.005396097981724085578 0.040581373361212508266 -0.05667854622438055906 -0.19402467382938418106 -0.22495883866384311367 -0.094194755830904267069 0.32862700643701142633 0.10277041900262155749 -0.37931922909794463239 -0.13561552867157586344 0.19784972830018110468 -0.20388790127664527252 0.53478979395605286129 -0.2112617857469754612 0.32053637567819620591 0.11711534154257295659 0.058571605365207841942 -0.10005109890977775811 0.39777013111667414158 -0.082097841358585166294 -0.0058429639814315962112 0.44306381778985509667 -0.30984003225266165682 -0.33779133545135470174 -0.15153401067415128711 0.48409425806217970534 -0.33480337329996312512 0.043539663519386789803 -0.3549996499602567912;0.097308686409612862867 0.30718011563874153547 0.26991327629425881929 0.087658247684883408568 0.058502922486266810409 -0.12725200206461065311 0.063614688498046731424 0.023145217495001608327 -0.068876579654648661943 -0.18139719592115649549 0.016510823358134550654 0.17778557796674676617 -0.24832882175719150908 -0.099262220876374582246 -0.068849683967575667221 -0.47164161145797789398 0.13332844983823310958 -0.24828133382099459858 -0.12596758128712992608 -0.10524302275545388552 -0.088110184383807091391 -0.019659463057141422088 0.010772795550810539481 0.039117531311137536398 -0.16568655198624787639 0.15757958174291641917 0.10385201187128130507 0.11432541143898049263 0.094080919051144046295 0.22196417979813654053 0.16825438597929140427 0.36105875352087601904;-0.75091800150723009288 1.3321793246615558637 -0.15214893452416569652 1.3269310241327230138 0.23064572195566182544 1.1694199419477122603 -0.10164732937602269369 0.7790684927309432517 0.24164925491189548357 0.32552109862689260211 0.18157403754095016724 -0.33323983602949969196 0.72307296983575430893 -0.81501939505677645226 -0.40424734458480027222 0.019068898684930085663 -0.1470256438249551989 -1.2716624338839535024 -0.19996674315119794541 -0.95333396357358579642 -0.43560391714338408953 -0.15060829861440375166 -0.4703843377038105511 -1.0984571216724976495 0.88654205723714596399 -0.26333076508024172435 -0.53481962371467883788 0.080948732893970282154 -0.37467826479284555008 -0.40359716382367027965 -0.26278366492929672305 0.014716244463400385625;0.19389856752084386193 0.38461341022760325847 0.84991317827904189208 0.37902674880423420367 -0.027105535667089602353 0.041756954547515927334 -0.13089906641037829527 -0.077076983112470243142 0.19751285056539003016 -0.081224909770545417054 -0.041077974177741803652 -0.0097842785513691400007 -0.24730764439071731275 -0.16167767911395702907 -0.1643284759316631094 -0.47853175898629057849 0.1745280421149416894 -0.30428662085279245542 -0.37496754173231000573 -0.1860934865582000719 -0.23045280568806711385 -0.1611660986575138288 -0.065426888133331001507 -0.1058058432157910761 -0.37734214316846248494 0.078497858729247887988 0.21856998938873212213 0.43648557185703784622 0.18765659458796635217 0.30961065330948195351 0.26568998108344799025 0.35155969608335729815;-0.63211028668762225813 -0.084410538299009102436 -0.14496763780921059772 0.30495479519554663517 0.28335234611659876336 0.19882839974302973785 0.027754970582471612944 0.88354504185585502896 -0.27819843168718105808 -1.2477346886184086383 0.37046075437484843329 0.077063310407414806202 -0.091149991405930788635 -0.18166175096947956291 0.08611030002506706027 1.2863436175168143638 -0.41632786398173199371 -1.5128055968718625568 -0.18660046500382426737 -0.81190800216849390303 0.7344202804304024168 0.94755063279365780993 0.9667668564092036787 -0.40022706047206729751 0.18474396818454411062 -0.16516108734696371974 -0.82476381099718876211 0.83718592687984960676 2.0784620504025572707 0.5446024118249257473 0.12189446578992577108 -0.9277857443531801751;-0.13843273251876764274 0.41139131500311104661 0.82097399570355922283 0.71319778888583140741 -0.069378886879847889713 0.084444953408936151984 0.10265778122893715052 -0.067050237421226108192 0.68595227411754589042 -0.51159151231632327139 0.030602020253211195677 0.56674175298488038699 -0.25247941387907463229 0.28660785841623692694 -0.20375317784618968142 -0.1349275856019132025 1.0239120330960920224 0.1777241259063304657 -0.023835974517799129319 -0.083520588650822971677 0.059869398769551225581 -0.35365280065510457108 0.16918411429486140962 0.12085768153962635207 0.33438865238059894969 0.64739822355061305004 -0.18417978475944427053 -0.20657500143203219589 -0.0018581095726264758999 -1.2933371579590018374 0.51173529756828417536 -0.010223139559347126787;-0.22493166735379266363 -0.96432170333831501718 0.021932747418752403246 0.53262487731950458603 0.70245800874612840392 -1.4181723311415683764 -1.0821722260036752417 1.4211088236874922508 -0.24298840513604133551 0.14659325130278164084 0.13000191844196656854 -1.2691198221493578124 0.17438257645995075551 -1.1248263833603606709 -1.1362502845276409857 0.27015781731573956792 0.9480800900816926946 1.4711018661797237161 0.76363710804619522321 0.35244764344352202956 -0.036121477445063519818 0.98836328183111477053 1.3013630560706599404 -1.4208653562575577212 -0.11471626113333045771 -0.55362699204682697118 -0.10929265408389768344 0.80088088194695516986 -1.4770679172974139348 0.50278044012291012166 1.2530516419500716818 -1.0880464795256481469;-0.0072251698910222482072 -0.32221450295323622592 0.14244637751392152936 0.36598179305343475631 0.015235767151414010556 0.07277514240918958599 -0.66158307261165194557 -0.34954464852452887813 -0.099151710699561343421 0.68121384805291806952 0.0049087045287756602557 -0.9922503732908884988 -0.033708557231788283115 -0.19254952322525914488 -0.2071466430842614781 0.25880504038004958911 -0.60764782511320880598 -0.17391680536154155434 -0.17715048539492514457 -0.24019093105425695645 -0.50036130418705715428 0.455770013405197294 -0.34306373418519447993 -0.36694576378863669186 -0.40853726945475027366 -0.81757889464277089253 0.056769971951782724484 0.73227986665361899377 0.59342866228786783633 0.79284851560935432069 -0.17812496800104976602 -0.079035143862115117552;0.1519327370261441823 0.36994297145639309932 0.65890010241565877269 0.35499881893040835523 -0.048552338637496063323 0.016692254654748980847 -0.11940925521202365445 -0.028222620351231363783 -0.041499809826058650652 0.07668484209905533644 0.16075247015756183311 -0.010858361001793527534 -0.40306799887373917501 -0.086426107945328706217 -0.19989971786509866392 -0.27563448809589841115 -0.045926665687496419366 -0.34666887006275542982 -0.41815601301796107014 -0.2827316548277241659 -0.2020606225650217469 -0.042601234908796879741 -0.076809013503560188973 -0.11867479078235255996 0.032048163449818471704 0.015984688521826689867 -0.031941101849705395843 0.17785557299402571241 0.39708502642486198653 0.2971747653553780677 0.24040734607836858339 0.29727972122119256104;-0.52556899877564544621 0.086602436739532676069 -0.070749654422551766508 0.46096726188129572011 0.2040979943020172771 0.3743018239928465607 0.019756591963857754457 0.66633922125292410765 0.17029240086152211409 -1.0275360567270392931 -0.026486949750912855417 0.020550963865960756444 0.45935717920474916642 -0.029295712661345209293 0.24823641229562126709 0.68668981911959126041 -0.15906281829885099421 -1.1467075050950625847 0.053025823018585521718 -0.59312658026447384607 0.51860433995373511618 0.37466816109878314789 0.56299380710972002362 -0.4625100758108826593 -0.4490463038798178097 -0.028895072096865821731 -0.24207998897619775747 0.88430639872583449712 0.96167985465484040475 0.30917482673593282838 -0.15905303566629580558 -0.43652937886593651262];
IW1_2 = [1.0604827850158062841 0.50515330817831949339 -1.4304012729334738552 -0.97554581601859280404 -0.64186155421422941281 0.99306484291387309149;-0.42417133943087015346 -0.26961020590346057579 0.19681014765227891616 0.31604798345626200495 0.26415043505913005095 -0.35999893821642220404;0.12844486066745788855 0.28459201319771360028 -2.1518529186787529461 -1.3971714803726416054 -0.30091677869853283855 1.159243346319037915;-1.0879580402449244847 -1.0823366059637553604 2.0367022001419359256 0.73457836382300911726 0.92036593787953324686 -1.5100740440660189723;-3.7215417415808347279 -0.65329227900049913202 0.053195246643909420425 3.2134886460204898917 1.1501862822559791866 -0.43958559089584142709;-1.6032130545104965602 -0.085100951165782409702 1.8905512215631785633 2.9089882322164997142 0.42199723979450448619 -2.2884450918518628448;4.9694414056057478746 -2.1542355720403567609 0.90210120142901928375 -4.0011691804449949217 0.16656607882012669508 -0.87570718292806359884;1.2746215873190023249 -0.11212635752761652974 -0.89745634770509408185 -2.5029498693848624136 -0.094836308531228805108 1.0523948111772811753;-0.18028387889356947693 -0.6463339781816707097 0.85968937691228841658 0.14857216895240044074 0.65953437232021194792 -0.70190403613069440869;-2.6935200663299099233 -0.31368804849283243863 0.020649437072713893587 2.2505374767403676373 0.6272154462722424606 -0.39958232003063920423];

% Layer 2
b2 = [1.2896233792095008752;-2.0884866168215405757;-0.37164225845897919109];
LW2_1 = [0.52196697160976590624 -1.2225174730580536941 -0.76860600875346163363 -0.73799956953362166878 -1.2971419537228527918 -0.46135720593774071085 0.19087592560782962181 -0.8385274456768625484 2.8183644880567486624 3.6847875087649573089;-3.0483498850598942376 0.045993184263708415671 1.0453533794231193443 -2.5642059561518895094 1.1982002599641019547 1.2267573651704097859 -0.11675434792261837891 1.7510828592043055085 0.23077168145869048077 -3.160181352256743903;-0.88763264210994430314 -2.1325705248180137907 0.11975883595419416217 0.27067091709536572619 0.12305874685137742353 -0.0012889919716509551893 0.018276734654125870866 0.0078812282805774923344 0.44676802905492746243 -0.29748390868955754129];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0354391208186784;0.0438105743716592];
y1_step1.xoffset = [-4.60253906;4.59144283;12.2107028];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
