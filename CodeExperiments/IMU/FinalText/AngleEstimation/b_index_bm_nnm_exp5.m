function [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP5 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 14:36:14.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp5(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 5xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 5x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 5x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.395963890646992;-0.25167455871334;-0.179220806703439;-0.218505017539669;-0.0846359555503018];
x1_step1.gain = [2.46688656815633;3.4585985335771;5.42321823082988;5.28904699348167;5.8899691022988];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-29.69847451;-53.08714143;-33.15052065];
x2_step1.gain = [0.0215259017867669;0.0437499215793593;0.0404677022966254];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.30496810902605564486;-0.13405717478055653724;0.23655597969253422397;0.061641233839019045349;0.26831305663208415702;0.23542639847433091682;-0.13670131409300398384;-0.12811276312139280309;-0.060426632769749646923;-0.063398420297231805609];
IW1_1 = [0.017504502705958619596 0.75059867135142122052 0.22148442289709105446 -0.25468412540141227574 -0.080446504136227850457 -0.055774282985946103952 -0.65380221519454018164 -0.14657739253547330538 0.21774626217639250769 0.21035253968735317942;-0.05952880732925099061 -0.52060064196491595556 -0.41887458898136359364 -0.64321910724595088293 -0.75337901455759925806 -0.14636755171509299722 0.53993389028745908398 0.24359922454921562052 0.51680679812922336591 0.84792173641908541448;-0.12996861654700958555 0.1170465901482102139 -0.33635587806172373426 -1.0586076541569002796 -0.80896342312470381763 -0.035281486231763678485 -0.12323154941980853094 -0.19711427244557228056 0.49336635689417007722 1.084459720403385008;-0.10165390423656699148 0.42155706317590563303 -0.16917103651727818936 -0.42267619393033284414 0.21834372392676168473 -0.10769753285608263393 -0.17276733939082372649 0.46607853197291665426 0.49467178719645116258 0.0090359037542656148873;-0.10366880192794292181 -0.21651757449886507856 -0.2475972391837101827 0.11593146077988324139 -0.29974167292786618733 0.13782035662487240879 0.37373024800919718569 0.19419893844254221271 -0.04955875795672699119 0.18728392207032462657;0.17433379826529690759 -0.74885085058736033936 -0.1781022157716641019 -0.26279290172373259704 0.01412372146860458276 0.49737195022167868252 -0.22299126218804418698 -0.1053610750772542709 -0.53791818565996407653 -0.42583209907111396753;-0.70923325999546082965 0.12559968330334220221 -0.41897113107765354689 -0.32253911041224708756 0.40267935325171505534 -0.028150866270929573998 -0.44230083151184090839 0.28614367270511043007 0.37345738904800174218 -0.18920156033537585683;-0.10096776699030546309 -0.21033527297551296575 -0.047291506454165160855 -0.3588900731755883533 -0.42745715885955137825 -0.048671800452623752153 -0.050294079798533591896 0.021742886547341147563 0.36415293505175333477 0.38459154934037487195;-0.0023464074112952001613 -0.1089194717128850326 -0.10737305315222757385 -0.014051917578047129834 -0.12474157517579426147 -0.043441582125408176318 0.2078719726916478383 0.091541671201964408544 0.096325779426754645773 0.1393269046240239728;-0.4392692559582321854 0.038358519622920458914 -0.0051081328940940700853 0.87147978442902851448 0.32678578824436932404 0.33424354970684577726 -0.40234117555151377443 -0.099914458920851795254 -0.61143786946371236901 -0.67037367730532604337];
IW1_2 = [0.079248765470109519549 -0.40101853641139539874 0.45323964013166423426 -0.69501553501145318936 0.22264858776405299645 -0.12653697987882464582;0.21433787934497552929 -0.65744003329889266762 -1.1206315627829592785 -0.92577314536486976504 0.25636185982941994688 0.83708205912897037937;0.52306909873835738534 -0.57475239526568278059 0.71089311995243797959 -1.4855933581318145897 -0.11618065860696805136 -1.1754438558664517256;-1.095673244122341794 -0.66744752726597333936 -0.52453560805776622278 0.34082962964862240085 0.7313342063215458877 1.1438992748914909026;-0.12484688637123289578 -0.31491031385543455379 -0.60400287748200776061 0.3587265424464948782 0.25039873207836998992 0.58671636575685115478;-0.40400536223625993504 -0.36393229469225424344 0.52926015790245395376 -0.28213312982279997732 -0.44983263666399270209 -0.64790396563889640635;0.69925634246607981659 -1.5645470308127362724 0.77130735633950420205 -0.60810518555800785467 0.91541127971693680987 -0.6053808785389968028;1.6934781336582240829 -0.81249556762890784434 -0.36025668795010268308 -1.6505637053543744663 0.39726235048863495214 0.54184323562851510747;0.32869416356757280573 0.39938029928113266687 0.56710986934810758697 -0.0068831635669616940409 -0.054203782419770321632 -0.0075732153477748040751;0.73935161851776198816 -0.26415456596487296714 -0.0070265796988128684936 0.35663867325505227424 0.11720013828752030849 -0.19917498771322103557];

% Layer 2
b2 = [-0.37792724324470217123;-0.35065916354909393293;0.020535597144157473337];
LW2_1 = [0.62734003612020394769 -0.40793836657041482319 -0.43911068613296611041 -0.92081030738950686576 1.2853768741499511652 0.050650998555406827328 0.59603266165717860847 0.17169066498115576058 -0.3363295620430667987 -1.002888784265911104;1.6895728160564646991 1.0949693757830496477 -0.92790138322606818821 -1.0580123389007540791 0.096473671426407933693 0.27363978000626487663 0.51980634073613485313 -1.2205934235253710352 0.23710352929566919089 -0.36059839032484913846;0.061692714361233830234 0.3521568428735551981 -0.043651822887952940189 0.069983976973598330251 -0.090813140848479398382 -0.091016318720723105029 -0.12105049360240609235 -0.22572352879427445838 -0.97245879708894822357 0.1730685169294419179];

% Layer 3
b3 = [-0.19846063338761010808;0.014766817155076890355;0.1670810278301304852];
LW3_2 = [0.54028614575974764911 -1.5932335984644887539 0.005546515250985257009;-2.5811952291347304289 -0.47458500589045349294 -0.29827747070209331692;0.72176706937374512929 1.216470351221799362 -1.3853469402935747468];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0215259017867669;0.0437499215793593;0.0404677022966254];
y1_step1.xoffset = [-29.69847451;-53.08714143;-33.15052065];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(5,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),10,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
