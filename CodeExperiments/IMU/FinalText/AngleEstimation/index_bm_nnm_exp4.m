function [y1,xf1,xf2] = index_bm_nnm_exp4(x1,x2,xi1,xi2)
%INDEX_BM_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 13-Sep-2019 15:05:42.
% 
% [y1,xf1,xf2] = index_bm_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 5xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 5x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 5x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.44187443254308;-0.290030409875722;-0.21809646746465;-0.200358474000746;-0.141009323793073];
x1_step1.gain = [2.50434222911229;3.42805241045766;5.25791464388626;6.06885454376742;7.36657891744156];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];
x2_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.035479785107528589994;-0.045486878642203826262;-0.23625030384384176907;0.06322899811982249374;0.20626452344922374671;-0.11131541447032451686;0.052202917942277847485;0.23018643240207670164;0.048442121575824635682;-0.29254846423769281794];
IW1_1 = [-0.46501913813879880433 -0.84552002753039812166 -0.99252905176133565668 -1.1947125246295129397 0.95266569584429461326 -0.34500868081105701135 0.54358946323129508915 0.85124858488784616029 1.2834783379487386679 -0.74080041941987850862;0.53468515769684488159 -0.78494046719359589215 1.1783722338592801382 1.0473612726470151735 -0.16044828025186685938 0.76353067032892640853 -0.29115533761477474517 -0.88763374113378312735 -0.59457806746509300755 0.64939058585524900291;0.12427269152261462282 -0.68698574128137079864 -0.55786304295401045739 -0.59855634366752119568 -0.22535004066939193224 -0.05604014913419537447 0.50355083479130624546 0.68928351369975981999 0.53150506812988329575 0.25044802805717625294;-0.12989491611857553743 1.2796546924204124096 -0.016414288660702949785 1.4245687171516741021 -0.36521974895504877301 -0.097539214172116889268 -1.2843442724071070238 0.31656918984389476046 -1.2453857720374950091 0.32496346078709481553;-0.56747886190515262061 -0.57022047896415772872 -0.18004132125911137541 -0.54512475687845507455 -0.48258494207084640104 0.27042280991759781728 0.66264260640592598239 0.2298545177814139695 0.4153678082031169172 0.3269650798306353856;0.70075153450629645846 -0.31857096893570124863 0.35589828130061434974 -0.012606372018562022816 0.6516599210302214118 -0.71924790608726574259 0.62996538812094360349 -0.16047378648255133937 -0.0048288978591935639156 -0.90928128339584157747;-0.42263286867016458537 0.0058152036300198432783 0.56044257580440781652 0.15781270479299758236 -0.099851932971919327153 0.32096159944019858612 0.20840363835394920544 -0.94694034957629003024 -0.069704917502144067565 0.066161043297218863346;-0.65124909913251172178 0.3166213331320676394 0.0099828085582466946635 0.18824419720169205394 0.14529616231019862327 -0.001786640798069407364 -0.26859389018742413358 -0.021534251386840366077 -0.1395904984757417866 -0.1808816027838499596;-1.5620777160885508383 -0.87704468153688786014 -0.92203703514109480732 -0.38760274118973053747 -0.22304525879833117519 0.14695767660493075368 0.65043948271612117562 0.47351153598747397488 0.82697614157581655903 0.35833943343978341689;0.56608584501021042001 -0.12177931810931384715 0.25914678094946436149 0.78698523368825723523 0.26940979795310487921 -0.7824554923848753285 0.27670233349407941104 -0.29941643238006099281 -0.42718247433874656505 -0.41321031169405775252];
IW1_2 = [1.7911522873883776175 -0.77199657162889223638 0.34013651251644139162 -0.67783104679957650873 0.49783157819628254259 0.21647416166792321501;-2.5840100510438457349 -0.49102280707987816522 1.4773033255635734662 -0.17462460158512752018 -0.45358771283211540837 -0.17576577779541655011;-0.46323585169879233359 0.34950041653615482318 -0.063697477017521514364 0.3864808495748758288 -0.73879041636784525959 -0.1305260376796014421;-0.0095765866524643375457 -0.081062668180471322832 0.70631257953500969915 0.44782669308615119519 -0.23974259637339909168 -0.66312984515935713414;-1.308453876274089378 0.49958996851363446368 -2.4323609126040688366 0.95782399593663147819 -0.47762217070465179392 1.8240494920634140463;-1.3012039690108039292 0.61172380898883738087 -0.64376949218803070085 0.58269428615264440285 -0.25939823009991475056 0.3961808947339289233;0.26615915815505614139 -0.016649263390334487905 -0.51737712643132593993 -0.10452866877052904848 0.59017413320215128536 0.81136262316139740047;1.2078240831455544502 0.64605927732118340057 0.80220661759057010354 -0.14344503069285849395 0.17444309180522118985 0.30520803866331003285;0.86960262937742227596 0.24070614811712290337 -0.28506071308333452707 0.8887086138277027203 -0.19025268153700949925 1.4122276917956468889;-1.0644760129694907924 1.169839786907175494 -0.090204779124818224023 1.2077394612847140998 -0.79644659132142769931 0.17149897627024840441];

% Layer 2
b2 = [0.1966566094099238271;-0.18809391788874110785;0.22655218791746872808];
LW2_1 = [-0.78566754494535551157 -0.13991931295937631852 0.63783528720544935275 0.15087732952897392469 -1.2803547341256540371 1.33533816423740892 0.1013689944724218972 -0.041494160416064948538 0.87474097021011898434 -1.1664140253360193444;-1.8367696443386423155 -0.17376528840437321932 -2.2430385816297007118 -1.4239669309292406485 -0.97209903885643922372 0.82420481469987783019 -2.8100960592542190142 -0.18201714511341623992 1.6918511241585010296 -0.83188164544248965893;0.0010918357487870612027 -0.067681121130619137372 -0.0010032202429277104795 0.59372504612467336127 -0.28906713551634827253 0.84766271459922570841 0.4800034780976433213 -0.99166530761722315734 0.4558725969331275385 -0.7180983759732689764];

% Layer 3
b3 = [0.12416457474281994422;0.13262782903173314653;-0.055914741766660308597];
LW3_2 = [1.3358355877299086245 -2.6145966821312538464 -0.32346618558696438317;-1.6026355009113586458 1.0092238314670820554 -1.0971273047429768166;0.96237913555185328196 0.66529449310647548188 -0.048410672334674650918];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0209968573482885;0.041868259268193;0.0430280155650301];
y1_step1.xoffset = [-34.63462114;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(5,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),10,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
