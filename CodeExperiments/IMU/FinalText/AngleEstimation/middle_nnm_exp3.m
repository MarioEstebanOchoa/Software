function [y1,xf1,xf2] = middle_nnm_exp3(x1,x2,xi1,xi2)
%MIDDLE_NNM_EXP3 neural network simulation function.
%
% Auto-generated by MATLAB, 27-Aug-2019 18:27:47.
% 
% [y1,xf1,xf2] = middle_nnm_exp3(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.2872;-0.1512;0.736;0.3377;-0.3962;0.0385;0.5888;0.3788;-0.3399;0.0772;0.8158;-0.3435;-0.2594;-0.0021;0.877;0.18];
x1_step1.gain = [6.46412411118293;7.58725341426404;9.92063492063492;6.25978090766823;6.6511473229132;9.68992248062015;6.83526999316473;5.94530321046374;4.53720508166969;7.01016473887136;11.7508813160987;2.26449275362319;6.91802144586648;11.2170499158721;20.9643605870021;7.35023888276369];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-39.50838032;-56.20691974;-13.03478832];
x2_step1.gain = [0.0195047175707841;0.0395706711489379;0.0539272120771512];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.35379227015450442906;-0.38850777411246545379;-0.31524359995710898863;-0.41283095825487170494;0.1187740719560831798;-0.018622700697941453607;-0.092306790644321498607;0.025361909359861899149;-1.0171480186502328547;0.17034537292613136095];
IW1_1 = [0.4574173369098228914 -0.16035231192958099289 -0.08662252638376662095 -0.26637526542703787724 -0.63792947423271662011 0.25078176829034048989 0.28354900079017431036 0.65464731369884221479 -0.34158278756890037009 0.0070071446047536697574 0.18641143344946400906 -0.43904111827515229782 -0.64773132130696975395 0.1527970535188639678 0.080886552751800788741 -0.18290846654628789558 -0.54664326490102155276 -0.078302038101084769917 -0.42702841943718355955 0.088084064206638681971 0.50005033941463428171 -0.065692505755128804967 0.26432414715595048404 0.57367373689415102067 0.83606036243692560816 0.28341532531847729581 0.15788869664682111948 0.80932581818604198975 0.11199535901036389296 -0.0091531179778190606411 0.73367528943758719695 0.36616413445055628895;0.25042108413788088939 0.29351348539417965178 0.25742343198597861242 -0.27174519558540871644 -0.64516331053661268857 0.22051690268956306018 0.38807547313232332309 0.63494635310620395341 -0.39804462849208521735 -0.1917324355159781557 0.14107363708626977084 -0.29468022551701278378 -0.28385188522418330903 0.47976534050269437071 0.15824639662547340668 0.33877349718739752094 -0.42025415709243596485 -0.45874173422890662799 -0.76291962652552869351 0.044547413573789704233 0.48919026669010090558 -0.1249069321878063521 0.20432498216733135932 0.66419256039662577518 0.72605669769156766513 0.42128948637714652703 0.17550405993680989747 0.98718233047572612193 -0.038878955913239129916 -0.1546436166134352308 0.54476978206505444202 -0.42403951180887416994;0.017124543495345371374 0.87552806685981943158 0.8304664840406182913 0.70394351760912388105 -0.23230209658448730536 -0.091335279292514365279 0.71836188849631521514 0.83270099179745737938 -0.74404206351373158856 -0.74403010480933085002 -0.67142651100661887575 0.37658112135935051246 0.57261583972401086662 -0.39767348413804876062 -0.4544879778760004263 0.31278761796782555971 0.083794977861165964583 -0.4175404822068735089 0.2710883267807496777 -0.17776424190762332711 0.25045023448455572268 0.11863350247955241346 -0.028986729600086202224 0.78859808093340699742 -0.52793285361709341164 0.55095207303206061855 1.1307938996921997887 -0.1357304310290750049 -0.66167632034397860785 0.27389279871524302434 -0.53707943354321452389 -2.0134243751153411139;-0.30417084941326955061 0.84516881306376312466 0.62110600053028452994 0.075422090048002835005 -0.14165172805139936152 0.3124788533875317853 0.75622288951557403713 0.087207282868664276476 -0.54284507348169619423 -0.38162507774569792707 -0.20944873393831256458 0.40367069348807299578 0.74650704661621203329 -0.14891197599281777442 0.43167807210306485821 0.70099058484108267564 0.037331577339146916616 -0.15847035714476190305 -0.31392878335780122212 -0.30124901380623880787 -0.073403175309039100926 -0.91278102439519848144 0.78112065329126811886 -0.21143696533819927863 -0.11199524344822422983 0.43252521707152069563 0.28893770987154387964 0.068408825241385542992 -0.91888895783548862894 -0.12983541663072900585 -0.8353067937777648444 0.23097199350676581031;0.69037685820025573857 -0.44662117842080134578 -1.2883578523663352655 -0.38078988049505574365 -0.016793527039968777353 -0.309742710685165068 -0.56611132162067967499 0.31202286764596348645 0.12374344500496374522 0.27552455944115289421 -0.35754231360359522984 0.93800567535800605246 -0.0032219523481874950445 0.1088287919773537199 0.093227535602302763484 -0.70287919712140434214 0.37220565574789643559 0.38103181756004061986 0.72767841278386968806 -0.13320133985402166088 -0.16473524173946185734 0.50799457217043841872 0.50552094483660259261 -0.85697499462567550133 -1.117912393913815805 -0.96110146345755664843 -0.13275306256744021094 -1.2157560335280594987 0.28832249766205508834 0.15378574422947288713 -0.22341792044095332148 0.8078900294757477285;-0.49326451325127562697 0.3475897064017628435 0.24272782115681268422 0.65735189451690634321 -0.46729467665643542595 -0.2217270630664416875 1.0932681872097578246 -0.13260867666505907203 -0.057225848327808304106 0.38803190846046975437 1.43390669361899592 0.076839106387328853787 0.35535975003519265636 0.06637932812236385649 -0.7642690993040062164 0.45100510377003877327 0.15253629219896422398 -0.59228286302654242768 -0.17052431140868115622 -0.37206688997530246166 0.10397706607654037814 0.037905875303408213817 0.024932798807155303472 0.87544989323930777481 0.305313067084287737 -0.35924551731232823304 -1.3403919461448385864 -0.84739554056555566053 -0.082007291842701071638 0.27582582527914584203 0.016109391892295266135 -1.2509248478911201286;0.40460916721545819863 0.64878048379055430761 -0.44015124716817610739 0.0074180700808376678554 0.17707939085978505189 -0.027122551117516290053 -0.7292361663886184342 -0.091371722638916366699 -0.56868985056806153899 0.33205515449925282478 0.14697806685526770831 0.84226326081206370766 0.083646852891943138109 -0.81600616866285524686 0.061669235904739008736 0.5556535221895637644 -0.080318412330051811021 -0.64909230916773374975 0.20918996122559527229 0.072721120419572016225 -0.50470480419551877471 0.0034669864146630565219 1.1586985965150500277 -0.021555968465401621759 0.34865044536915296147 -0.43905153118020628922 -0.20189688661027341277 -0.54594495271975018724 0.024674666615024064276 1.2437421012906826334 -0.017062178261306012311 -0.46236664455643688987;-0.01431343724768858322 -1.0496271355179962459 -0.067716846218062259899 0.45064580727413577899 0.67378934200648199493 -0.066478139502014615969 -0.61269652314615474786 -0.71229499262166084961 0.21596629663226621365 0.43116911504723598458 0.33616286871225531385 -0.7963488678846634139 -0.53901448159727993747 -0.65469594808433961841 -0.1427877703160573275 -0.72101394366455440199 -0.34993753513938402611 0.80787798728264015313 0.76542350309346329773 0.34266299362173180398 -0.4446377997259448045 0.26668386938552079979 -0.027441292105453790606 0.5353567856300721628 0.84231915015018909987 0.051234974576980729655 -0.050501278497052527749 -0.35618723611447861144 0.31399153610391006275 0.055676481475358099993 -0.08421456658954613872 0.56549974668324842764;1.0389415772719257092 -0.024146925281946653163 -0.080293902556257831793 0.029131768520905574477 -1.0569872475864252603 0.19036139378171487713 0.94196559443754601659 1.847441721413272564 -1.097439113185704862 -0.52563158287617084419 -0.60670662241403983117 0.18283344294882802883 -0.23073842546841688561 0.02080789965583574111 0.096255395337267790623 -0.65276089599677000752 -0.56291088222357954507 0.29532821744973736244 0.25762294699092713746 -0.16091029623060157383 0.7293323252206653784 0.018386155891845050447 1.070283506724822864 0.90538636909212477644 0.037842526002237732163 0.47386807346686210529 1.2887251923619353899 0.054261118297199810445 -0.58369902456508837574 -0.19045067690833192287 -0.20368570376714822956 -0.0090676453394562782362;-0.33499138394718308565 0.25435171865161354532 0.25606808326946611798 0.44064954469474415522 -0.42905257151257286674 -0.14981265418799361022 0.90135433028558031854 0.25083591945758260122 -0.080764616310209022543 0.11890103756594345985 0.73803401426233639082 0.081044382776329512708 0.26551827279110840063 0.3980375012116116884 -0.62195686338905176171 0.33891644240288593126 0.18003845149110009327 -0.4156587798536510725 -0.16327230303406231604 -0.23949650067147748578 0.21865994382920114769 0.092045198697504257423 -0.27796775969330217437 0.53162343398705202979 0.078244027486783121472 -0.15884188638062421428 -0.64356287971412484694 -0.35587888652037769077 -0.012842048736182788346 -0.066392443035245482519 0.14768849933606334468 -1.2318004632480159533];
IW1_2 = [0.58022057416732752966 -0.045840599692425008926 0.28791642776656090064 -0.71251017356576906714 0.66828012691830662728 -0.20657931498934495318;0.87850921869635445471 -0.74401094633304065695 -0.18337419196138390887 -1.0569080265840580246 0.82973992311544353395 0.11107387212592320647;0.5177082821007114033 -0.4789068663196510145 -0.47819267662941439267 0.35033960279529019477 -0.17690389677628093335 0.77911129992618977091;-0.30733303670723588485 0.0046583365015127314174 -0.46549651805433156504 -0.12950911675377554944 -0.99983347472445383008 -0.36529920714062874554;-1.1920698885932998756 -0.036903668407496946491 0.28035379408803068335 1.4411825135562839062 -0.48632978654687836206 0.044369147772731827584;1.2000570078749330793 1.6188074729355983461 -1.1233052294451775222 -0.26297760425750882352 -1.2816879136485330726 1.2792901597361225896;-2.8612480524812995419 -0.76501073010490783233 -0.35594012480850828473 2.4393088147563886103 0.52241335971481805966 0.53504616186229214669;-0.34896268265625957072 0.37164609425575351187 -0.095217262816900877231 0.70238565353405302272 0.44532048801286483464 -0.18228505053193458374;0.38442004210316527146 -0.51758885711163105103 -0.29269674120035771292 0.11976288870150042509 -0.0077322589582299750682 0.038587287721187822631;1.1395560121491135064 0.17020619512823514929 0.001551103734377626709 -0.4063945005324043902 -0.24095039059747827559 0.65773023494295035363];

% Layer 2
b2 = [0.046515052447856052031;0.066012331357849049485;-0.4156339917506492454];
LW2_1 = [2.877260998566524286 2.9670506453151626047 2.7900174119319802735 2.3901471502617623877 3.7798099440818391237 0.13568661906006493356 -1.3394812403381513022 2.3962379249422260941 -3.3892605368934174415 -0.19420459339360071627;1.3361477894274198519 -0.98502383807996063414 0.56194828446841349479 -0.15090526698730580279 -0.036413365324761200192 0.79805762251594936085 -0.057426604291228471044 -0.42756224624192540329 -0.40214987951990732729 -1.2298135294385319494;0.82457529051306521772 -1.68844908609789357 -0.46895415774667170705 -0.067436918832257664036 -0.59004875291652514324 -1.0056171330466563418 0.16812921972538508175 -0.3593061073788498816 0.32882186492755355323 1.7072694558188401537];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0195047175707841;0.0395706711489379;0.0539272120771512];
y1_step1.xoffset = [-39.50838032;-56.20691974;-13.03478832];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
