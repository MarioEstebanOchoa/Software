function [y1,xf1,xf2] = thumb_bm_nnm_exp4(x1,x2,xi1,xi2)
%THUMB_BM_NNM_EXP4 neural network simulation function.
%
% Auto-generated by MATLAB, 12-Sep-2019 21:02:35.
% 
% [y1,xf1,xf2] = thumb_bm_nnm_exp4(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.2185;0.0567;0.9076;0.0855;0.2868;-0.0432;0.7555;0.1799;-0.7201;0.0064;0.5702;0.2422;0.0864;0.1523;0.9267;0.0585];
x1_step1.gain = [12.5234815278647;11.5606936416185;45.7665903890159;16.6666666666667;7.46825989544436;10.4112441436752;11.8764845605701;7.69526741054252;5.35762121618002;6.53167864141084;8.06776926179911;6.4246707356248;11.4025085518814;17.4216027874564;43.1965442764579;23.5017626321974];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [19.91904251;2.583829047;15.72255665];
x2_step1.gain = [0.0470926729892737;0.0376234231319031;0.06953254154686];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.018908295658194504418;0.70015910312340778887;0.60280565047957934688;0.20223784266651581576;-0.038192943068224918801;0.2529720658496902308;-0.99241851277476411664];
IW1_1 = [0.025337370509096717591 0.63242851911349828864 0.26502820593227921497 -0.042466346221968730157 0.1998201597454829781 -0.035560868297132647298 0.18705487873888254624 -0.076881384181574516368 -0.29039715110842001522 0.063142253809840218071 0.47874544646701050477 0.26539663337869784376 -0.086998746427003115222 -0.41533765161386293485 0.17312571839110740823 -0.17441594642780380853 -0.032513028837517846115 -0.63291506176277445572 -0.30991149566916853519 0.11316238113184581837 -0.02372982065888673206 -0.017007542785792518353 -0.021195929214604995738 -0.0091744814289555012832 0.21106802473806646203 0.1864184174272897343 -0.060577231102970252596 -0.24564257102271161437 -0.43229667613583772079 0.2885797601318820238 -0.55105342082004471482 0.025578831287337726319;-0.20285526467153230934 -1.1592202526131536455 0.3504730864855428174 -0.39527742552657196828 -0.52994436317319015828 0.21607622044091245872 -0.092787900157142375046 0.36479943748754634081 -0.69053022477885506181 0.25723343031368745004 0.30363809508360450895 -0.50309137423460048577 0.18907982035401532661 0.78575413360618928671 -0.30950530662484004862 0.71301164927969795659 0.19033719299328918928 1.0694591263091310918 -0.35106390781174134919 0.36297378893126353017 0.84326808312652323796 -0.3617198478210230661 0.2015552045786666302 -0.53208675700045271473 0.45067187871904013097 -0.40316722479507072219 -0.57337862671607153775 0.34096128957785359903 -0.085766328294426125156 -0.46768248187372774005 0.40343463964240444675 -0.95676785858522972461;0.18001305908086331908 -0.38743139164844525579 0.58056502435979195909 -0.27191049252733295871 -0.40431135545708102308 0.19904012668456300128 0.02342543726755739672 -0.021757741471521780535 -1.023103388200612196 0.27920026928974389646 0.9077891749242098518 0.053803639754890789093 -0.087724703538875042907 0.17422291505451523164 0.30678924558606723849 0.23021481180459185678 -0.0038294812362429306307 0.34041497220222960429 -0.5280188805947362285 0.3569473734052074354 0.76121974058484698222 -0.2675752480093075425 0.36058204170315322212 -0.10800787220478502704 0.45255181802874105967 -0.10035706042921284376 -0.53660239662807307504 0.057837577414002375176 -0.70559054310723046122 -0.10309779110183464601 -0.78079721703315152492 -0.55544374628854231712;0.1876015249640916871 1.1925883509474670685 0.020571179272571984281 0.07803435608691668135 0.65288546881000708577 -0.40248798049857364978 0.37614809786288733173 -0.3802632290374516888 -0.028947826534064271392 -0.044399062933654191709 0.41282623040946769821 0.57691418136824312857 -0.55222283127214411014 -0.65829116440314472403 0.039935954852300163676 -0.47719915517440769648 -0.064949429113150505821 -1.1413066150060409143 -0.020541227301370854064 0.0080030498274521084945 -0.59355223483131147599 0.41491081105605076562 -0.20072776784646234605 0.39303851457905197853 -0.078663246630056679609 0.34812901244962118907 0.16847097310512468282 -0.42805164194005773659 -0.13125574560631206311 0.32456434274244300164 -0.62267111432560318107 0.33243244456743681337;-0.23163077096657527787 0.34240021311627716338 -0.27048353733343521998 0.20031084349089781083 0.28009831575451038521 -0.078802662890568447862 0.037509600466076764569 0.097783111746152104327 0.52644259613604604819 -0.088573219021752150337 -0.43709016474678308306 -0.097072084596390564859 0.20137812795338641547 -0.11477260071242260941 -0.19462668540747263268 -0.1039812687044111561 0.08690253595256076935 -0.3066680798623706572 0.23756502011482968917 -0.24151598822250952558 -0.44534276270125427999 0.10260957151300469092 -0.29020237377385282862 -0.046538266457826375777 -0.19768378779137649182 0.038893418039059712843 0.33495015759888918661 0.029390099434185228827 0.16684937621147563624 0.0551216569895294356 0.4112548354133910844 0.32018598570993900276;-0.6045442531977128775 0.85235771415120376027 0.4188584206143715627 -0.20462926636503178668 0.47654636801929078915 -0.24723036201435319437 0.21929115635708815168 0.061002573658400227608 0.13181521176305982523 0.12446908489674798903 0.25176197405597783296 -0.32180979241140389435 0.13925908213845214489 -0.32861495823285313822 -0.28785858824802307288 0.48082445404496365615 0.25041693020202693276 -0.89790028377530628489 -0.62317554025350974101 0.24804393543838312852 0.078435080793347461414 -0.067644390566072909454 -0.056714041421492680795 -0.34643650465420600115 0.48563296426957053287 0.19767597594649016779 0.063445106000115186751 -0.19201723494736938624 -0.50357923957375039237 0.42649496413677473461 0.015389219258653668784 -0.54391851008762259756;0.22247856793949871701 0.25281127628613181413 -0.92261043765609540568 -0.46462936522192416211 -0.090666386355855180246 -0.60193997437258317529 -0.10818972044128864762 -0.71482807198841058494 0.23283106229291025691 -0.5052784809333873417 -0.66459010308620569685 -0.084348353215441707054 0.86606749056777920792 -0.42341078407973997688 -0.010451689425223570015 0.099714147043887715882 -0.82290149757224917426 -0.48587956996544506838 0.34215472800715834856 0.38126427763188941444 0.49636746014550114925 -0.18530459743002522521 0.26268651642972773441 -0.17873099033082975873 0.058837318213204967132 0.065419884571079681135 0.18896788863942851067 -0.21207807140084597441 0.08971769449555884457 1.041940090220604187 0.41935210901927150173 -0.84883720264112849652];
IW1_2 = [-1.1949420372401038382 -0.904486556933989716 1.2601067770532292656 0.9290610455488522712 0.80831412099441024566 -0.79064842325306738946;0.75159847683762115444 -1.1162861109945148019 -0.41359956754479298979 -0.93793898935463926314 1.286304354359562252 0.61024432755315394239;-0.19087226405494664427 -1.6017635764070163873 0.53421113424057453667 -0.18467393223861741647 1.4047065274636785226 0.22095561159098589532;-1.2502638976212228084 0.1519981324579616766 0.65466557561049742997 1.3022592849691561057 -0.2924852111396750165 -0.88795385856486996889;0.035178692806089310874 1.1146494654635827892 -0.34105342114803166575 0.14177724212456008224 -0.61029491778245315015 -0.12285860323676561778;-1.6060207942033564166 -1.9794222963656242786 2.8410870755969201973 1.860221834780853678 2.8965340949752191868 -2.0570072452390792961;0.010344251728979408575 3.3787830366221962564 0.57460251619177604709 0.6637664941999829038 -0.47684667260477853201 0.56068581736464861986];

% Layer 2
b2 = [-1.1003925398495844057;0.97390502687904290102;-0.39283274683504537661;0.36211534592629163187;0.34468270412297080663;-0.14762517338388425614;-2.032933490025075951;0.43083628480114971593;-0.4617492132765504409;-0.20910922272462317828];
LW2_1 = [-0.49749583440568334591 2.3964829789550039507 0.58436000845791458147 -0.74503045525334343768 -0.74680131424516094096 -0.022675811628415091376 1.5141390636603218045;1.3515960017172989893 0.62969809808291865583 -2.0287943913291703879 -1.5925659413335444547 -0.52112050483001393086 0.22976811417718584485 0.46335894605282118563;1.4073296901055425412 0.37532174451374616941 0.0059270594478323945786 0.62697662335273185441 1.2596485650255759836 -0.83923259196873178922 0.22157377693601798541;0.35048766305501610763 -0.45941320293119169982 0.49409329391422901478 -0.36902782802075090318 -0.15896623798965683894 -0.59837285162737874344 -0.10774576777420065421;1.2676972520257743238 -0.084362503475832489874 0.073134783012103313227 1.4905630196590722303 1.2449893300170475907 0.39856278329900529656 0.38239315757476871616;0.48196108722631586518 0.30205460994515254125 1.4883699346760908 -0.067048803637797957378 -0.062276546807756114066 -0.14121945475243899426 -0.014306301656837201383;-1.306046309938065475 1.1751370009653032689 0.5265284336982252178 -0.26074533255426463052 -0.47455873439384371748 -0.031667167848608387959 -1.8718115658058283035;0.14087078272859565597 -0.32514427943339974103 -0.71947783237262663558 0.65244887350372327006 0.022023016470353491691 0.96903103314407490476 -0.10138861950652400257;-1.3059243417687154132 -0.5923601292934825846 -0.074616306377902494318 0.16386379785949095611 0.35768523412109815007 2.0522029946934461364 -0.95317834703135984054;0.26521777935821549965 0.43490324802603019805 0.49626701484185931079 -0.38945085173623827934 0.48776771051106132537 0.077951464928082081496 0.27591499907595828933];

% Layer 3
b3 = [-0.33554043363888141904;0.40445383276358232161;-0.92951229952723180006];
LW3_2 = [-0.40905869329165278625 -1.1834032150057434141 -1.9557008553348400604 -0.71402173348594855096 -0.8763286460622572438 -0.69737695326494120174 -0.44689440491243648257 0.98817142498625465397 -0.75738587490774889055 0.74844620134792727573;-0.21640888436349189905 -0.70853160459454633813 0.24118627953413007692 0.92224114129751977309 0.27986193366563405505 -1.4211663103054514856 -0.30671395693372494051 -0.94435171089376657161 0.61942423825630066325 2.7292677798125493105;-0.46508600243977538113 0.23034188055065721312 -0.93206588838100434824 1.558468741695347104 -0.0064219977393969391102 -0.055575314687139519554 -0.36782664056160702115 0.57343968534234601719 -0.079347237175507540075 0.94837887806062104445];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0470926729892737;0.0376234231319031;0.06953254154686];
y1_step1.xoffset = [19.91904251;2.583829047;15.72255665];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = tansig_apply(b2 + LW2_1*a1);
    
    % Layer 3
    a3 = b3 + LW3_2*a2;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a3,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
