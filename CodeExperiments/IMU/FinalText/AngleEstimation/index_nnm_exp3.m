function [y1,xf1,xf2] = index_nnm_exp3(x1,x2,xi1,xi2)
%INDEX_NNM_EXP3 neural network simulation function.
%
% Auto-generated by MATLAB, 27-Aug-2019 18:24:23.
% 
% [y1,xf1,xf2] = index_nnm_exp3(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 16xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 16x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 16x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-0.2493;-0.1472;0.7933;0.3099;-0.1999;0.1149;0.7926;0.0706;-0.3634;-0.0568;0.8731;-0.3286;-0.1469;-0.0325;0.8804;0.1802];
x1_step1.gain = [5.88408355398647;10.482180293501;13.5135135135135;7.36377025036819;6.47878198898607;7.68935024990388;11.2549240292628;4.41793682350342;3.94788787998421;4.35445242760723;15.785319652723;2.87976961843053;8.22706705059646;11.4285714285714;21.2089077412513;7.6219512195122];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-37.58893822;-56.51672659;-19.90957524];
x2_step1.gain = [0.0203652161747678;0.0399559081207787;0.0383263708961283];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.86550462420824170184;-0.56236340883858992878;0.60704598448247593101;0.13155783772566126411;-0.24263864544827917769;-0.056624959243303234213;-0.048674497759484541826;-0.04908258106964893952;0.82404308785784108338;0.2700792485682898536];
IW1_1 = [0.66037139176503578675 0.22575389647037316654 -0.063210218868272605164 -0.10865027289453847714 0.67715655703303312407 0.50479922681940692097 -0.55720516276122733501 0.18998949714900251196 -0.81360028904541625838 0.10542446322567972095 0.60675829361611588464 -0.90492742968639172663 -1.0220136359930866998 -0.82008359629055505025 -0.33453811649296782971 0.23513502035064023921 -0.65904529386698773585 -0.092800396416847480419 -0.21358775481232644688 -0.23813927523797034924 -0.086197928785676045105 -0.55888583529102831005 0.74376507583584894334 0.83045378608968867251 0.0063342489204170444525 0.10541607649063826357 -0.47207703500582370859 0.59631877669909738593 0.69118663894751863896 0.51330542078599283862 -0.25636709206404301176 -0.26630470694517671681;-0.52104007428368237509 -0.69541591750421871687 -0.59744087082874974826 -0.033745046603433248578 0.17932959756676383756 0.56437096639326378433 0.090845777152979825808 0.18628841691292541416 -0.74641187130149588835 -0.31348830992738557777 0.47822719144933822921 0.70821787754724740971 0.11782297860017085234 -0.029106392772370169586 -0.17490432758107865574 0.41846784515407342564 0.53764373055044833993 0.45005590958945368429 0.15949209354768406621 -0.38648180783221647294 0.39646125781893154505 0.33874020292046780334 0.35636811947625190999 -0.25535679155578960842 0.79159041414441333462 0.18771205417806999249 -0.37905462860636912614 -0.27285165663986882256 0.058688548691288644488 0.35321042195406299191 0.5415738578245798962 -0.40493379218675090714;0.25145069088589877548 -0.3106304811299278601 0.22722658504850209993 0.27751061156789330608 0.2089933870253671 0.2154706312243094557 -0.59083282680724602542 -0.1646711300226482988 0.29798285886453984572 -0.0025107963278769591248 -0.12444148258582195254 -1.0903437236679303091 0.44900551732098886726 -0.42327038736527555773 -0.42734945409063290755 -0.12851218909742231911 -0.069263236764011304469 0.31566381659057846099 0.43007857472397081899 -0.2103930944095808997 -0.26630197741011346624 -0.91313966831248172262 -0.097616416768576352858 -0.030301201583156116975 -0.67800468958123272234 0.35151206315873134711 0.05009960779487422633 0.86176879934433581187 -0.72868374369856148132 0.18610869778897784488 -0.52040448626308988267 0.37349384941840885199;-0.30312405525371138859 -0.11981682044081633232 0.63899608230937798847 -0.0043430481375729352092 -0.030746797228960159182 -0.16606561034736061488 0.35407021528228493912 -0.40297466151294142334 -0.43810204359475884983 0.15222382634981265759 0.01994489925619654519 -0.23218151254065913514 -0.033107634796375920438 0.3256717847626440232 0.28373979222845041592 0.082724739048755130399 0.031300309155794243943 0.077245845771616417075 -0.30954076408290603917 0.27378766624858008605 -0.14462265281929312377 0.084789768422026304262 -0.47491096620632572423 0.10117115861818716527 0.40823216031850600993 -0.45854614529817011581 -0.23823328513478664314 -0.24492021971091662569 -0.10739100690796918314 -0.34459951612881351002 -0.27984571593858592609 -0.048689491917251262465;0.765420477122830345 -0.17802154493330363261 -0.0590067108357128986 0.43101140124936099252 0.38895342024013129789 0.63146320829509861028 -0.25986068467168493834 -0.35659043824921082821 -0.39364230535930272437 -0.2556075712894864127 0.53807024256629265579 0.1409482842630536692 -0.64267682587782481995 -0.27367564169824626363 -0.17164990646927488771 0.89665460886737646806 -0.1775197161627381226 -0.081205086359941475171 0.55564289509226283403 -0.5863557558303112982 -0.24979050219927703691 -0.46819788613519025544 0.46641735987136340169 -0.24926723990423826915 0.61006681227967629599 0.51133533810960596355 -0.50749676450571534758 0.11284099800013949744 -0.26859106484668482384 0.68088328996496949586 0.096116877402907488492 -0.010975590437960383583;0.14094448686307631258 0.15042209057484759449 -0.37760020867365495789 0.46735682280566431812 0.027318313458555270462 -0.028611390291953982257 0.073122591175928980389 0.37853676081208625925 0.13541147058456717844 0.36489814345410692686 0.33990906634250894758 0.21828779663155953306 -0.32721170367393942469 0.15644257928562949056 -0.13812313846239315795 0.1174832388308584552 0.0026455839930953099423 -0.23470880180253278491 0.55492329675476670392 -0.4072354495637866556 -0.15802751754883392898 0.11739816264371349952 -0.2545796307857375318 -0.82306149204744016856 0.0010653279614060593913 -0.25573458059420706157 -0.43161901965812571325 0.063939392133668337959 -0.47424914606455942367 0.30164678144225243184 0.25596123455757363585 0.37322979681905860128;-0.56328955532007263241 -0.28792990508349974865 -0.45574522957738283768 -0.18042397891626016371 0.09546026634868746974 -0.30914561302340831661 -0.47294034264161993741 -0.019065686451927806033 -0.22871479152639120902 -0.04352076905206738594 0.0036417943817172422974 0.18569912483221492905 -0.16371011619423167516 -0.15608202838881229946 -0.15488683041753054104 0.43651943806728754627 0.15728771751201817142 0.24630244670120557404 -0.40378847970424608382 -0.30897125275097575559 0.375456794117936421 0.66098798234313438371 0.28536052138161804859 -0.028426421387418108339 0.051924770284727125857 -0.19771518302805052292 -0.11089321149854375337 -0.045895932476516493326 0.4604836850705543716 0.41116468199596334365 0.69691179439883688129 -0.39589738774677363242;0.78226640772094979681 0.78777828901561819386 0.47080987423576148299 0.15972270169149568875 -0.073148886544374819296 -0.075174059294023126698 0.29131646124006288501 -0.15880794954312191236 0.092031796713585869996 0.11085007174888386605 0.1883004407831807836 0.29727005587822896704 -0.59900219328625814441 0.08373798399972627593 0.28713878707740536633 0.021401635156933898618 -0.41066727588235107937 -0.69174504386635515818 -0.05504858379886884423 0.18473600592196476322 -0.36405345369779562592 -0.080716383391289558968 0.28710981432265303415 0.32237780066829546666 0.36723411361245889006 0.045940979589939694161 -0.034944043572919837592 -0.29066526020437294386 0.25455475586540116106 -0.14349776520450899242 -0.25542147427677336369 0.067104329656158340223;-0.42215025066633110606 -0.38991799571248442202 -0.15906202077476849777 0.33727840995535735003 0.57326560531139147958 0.61935443969728920521 -0.091020821522525913183 0.63708883087429224457 -0.71624187968103170121 0.5880244915853395371 0.80526702403828565036 -0.71760244940500361732 0.42354087625945974205 -0.21532891345627971913 -0.32815260769125931262 -0.6026895241296448269 0.35074532844370659435 0.50390109920350911743 0.3880829810425590054 -0.23884956172189208967 -0.1860137831408555098 -0.53318541348326209395 0.22786738834621253491 0.44381852095362261945 0.028630552988139167797 -0.35470560874738993329 -0.58528421224498161646 0.56382706312191976927 -0.58952834004465093365 -0.263952623405802278 -0.62408852029024786123 0.13475161632391211008;0.28139158189398078003 -0.30873280209755454839 -0.28053187394595296977 -0.18528669717260240479 0.067258609920479731081 0.093762447457915398807 -0.38947566011275003284 -0.28014940441573821239 0.12193243276343491976 -0.28068494056391884994 -0.19642680088117708825 -0.39476779963771496673 -0.24476234167174681922 -0.33859162653876995197 -0.21171255037326691673 0.20856364864116475055 -0.16664752995418377624 0.28514375398929187044 0.39008141370322535479 0.089425209995865923007 0.076215897524770578886 -0.2418798294884302591 0.21230879072098174376 0.19894658432207190657 -0.27721488438839197999 0.31242259145662032438 0.13680023619192727136 0.28001387215811435194 0.10166900934437408943 0.26942182039681333849 -0.033590851679821676079 -0.027975555879088707251];
IW1_2 = [-0.85148429535067726714 0.35992778326255769894 -2.3277584766058128096 -0.31023463718232369146 -0.76462675760185327967 1.1736555519024172156;-0.28568357082597378716 1.056769943696511449 0.14431771822594963162 0.10841008253051420684 -0.055818872835049451742 0.080832826694977377713;-0.2412914938092792505 -1.3740011903101028157 -0.65660329911654269353 0.039037737103349109957 0.14830488820931758687 0.078185874490864892827;3.5798377093273847649 -0.79481597693127836735 -0.82529798941490695174 -2.7146968267951652187 0.24032846128215962223 0.68741158973999882953;-0.35421486124051104749 -0.62266154691665343002 0.3385655206852601351 0.053593752392635862769 -0.04488370857870338515 0.13662426872322117055;-0.26753316886764372251 -1.0447981220915874001 0.45155415130062720452 -0.51256476095765957091 -0.47000516615065934811 -0.05831934179609372243;-0.026465343875525439155 0.34057532542853535817 0.57937339824399836097 0.0016750403712598369282 -0.19761561873268176925 0.068087979172921933579;0.01228367402672988877 -0.35514789316590894552 -0.044929065311771085311 0.22936824213528569927 0.24078785618604084395 -0.026640821646086922103;-0.13256632680532035029 0.41216536795590119624 -1.130653484095670791 -1.1780903836698322085 -0.69400750677037270631 0.046680368146220584114;0.65242777004513774486 0.77731702819039483199 1.1170078433278205488 0.012522982848538383865 -0.2406448273903113444 -0.33064665893991040946];

% Layer 2
b2 = [-0.19909390204332777508;0.0085417400655234537732;-0.10357990804764494186];
LW2_1 = [0.33555536069631841656 1.6637916782742592225 1.3302461305339523534 0.59196318292252669835 -1.6651963809164189723 0.90715355763235594466 0.18811025400076350489 1.793387649143257434 -0.60422401232252287429 0.79812399132885492037;1.2114911042969465083 0.37099838914632804476 -0.63673968701316630003 -0.12758335933682049546 -0.48694875016585503769 0.71892835917639330567 -1.7097626521278836975 -0.87480944807324279022 -1.0484432138430863635 0.83708447195359125814;-1.3687559024480397962 -1.380877987017336439 -0.66759381003013329448 -0.26819717099758155765 1.3036449642326453091 -0.90496332792736500217 1.0825267058776844031 -0.30605126689719291955 1.5224480348462650081 -0.1738110225346855553];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0203652161747678;0.0399559081207787;0.0383263708961283];
y1_step1.xoffset = [-37.58893822;-56.51672659;-19.90957524];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(16,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),32,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
