function [y1,xf1,xf2] = thumb_nnm(x1,x2,xi1,xi2)
%THUMB_NNM neural network simulation function.
%
% Auto-generated by MATLAB, 19-Sep-2019 17:25:57.
% 
% [y1,xf1,xf2] = thumb_nnm(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 6xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 6x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 6x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-4.0614759468729;8.17122518427077;25.2646775604467;-4.10022324292239;6.9020664592297;24.9175021200314];
x1_step1.gain = [0.0357178119857917;0.0369756476389131;0.0596712613290543;0.0368362107940123;0.0358002095604124;0.059966120575698];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-4.60253906;8.007185151;25.69303831];
x2_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
x2_step1.ymin = -1;

% Layer 1
b1 = [-0.074412002674955651793;-0.19133251405690260283;-0.13373692797524450171;-0.14373677092234132813;-0.0065817921712277675794;0.038378697100238286233;0.025053996845693191076;0.12961994574909649347;0.75037444556510690674;0.10138031718329017228];
IW1_1 = [-0.39628740570612536187 -0.026412648767231164393 0.83495246598084660317 0.05853161828259869498 0.87826117531984282394 0.086381473199657290984 -0.38777507730000493336 0.039087316476815271715 -0.17127585907303111146 0.10461430902183778413 0.062691250029911271824 0.26932865444430703628;0.83227038271514253154 0.2250874376202617877 -0.62879035386440684796 -0.52343899388600745315 -0.55433665637970297446 -0.11277496159574813828 0.039987643341017425902 0.038363505616264302611 0.11964405801243739591 -0.52390875197973663102 0.14944386922648705829 0.20134464678246127844;-0.021898303477674310735 -0.44110443491966511154 -0.24537357868944981165 0.061852964839109889073 -0.48723618040871263801 0.12372884916839342606 0.1923253336603090724 0.018442555244542906123 0.22732314082361396168 -0.033867969583441230597 0.14970260834235357694 -0.29458311141316922965;-0.18830344398525475369 0.51177414592456926812 -0.85145176126071109302 -0.46482739573529752164 0.24346536477266000897 -0.46313978504419722748 -0.11269859939183500541 -0.020180794177528091349 0.14417151691506899236 0.31314521495537855911 -0.45993386529255875228 -0.19587435878919801091;0.068975736145598778859 0.67027707056792540374 0.16869710652569833154 -0.26082270462711448777 0.38318483896761584839 -0.47169012471518023677 -0.15332985981864172276 -0.76424560574084521303 0.34295840862662846371 -0.13111345554674697089 -0.042895749864184484768 0.50900886076366347321;-0.28556592241258205167 -1.27633105512179168 -0.16492263060379819262 0.26806762620054158663 -0.46596927589547365578 0.09661684175924462048 0.26496340231272025312 -0.068173443973017430753 0.29207590453038290157 -0.15987491978460521835 0.37047986805884119965 -0.40919716246584303398;-0.17011862649363135302 -0.78194755286175621212 -0.07142195762088208999 0.007242409582241397456 -0.45233903146812920459 0.67700152087708143078 -0.14574891562657577015 1.297218786216773001 -0.88136197163680596312 0.5421152036109089245 -0.32154817576536065538 -0.9990607401058558823;0.47777305155792504365 0.3823059930261818451 0.17199522168544689738 0.99292421073249370611 -0.56610215758355664217 0.52507842311143571035 0.36121829491808687962 -0.23741388301621957346 -0.31337108373138122808 0.19348861372886005938 0.50712706578824928716 0.17913094254737144118;0.071307294071950230729 -0.019003521275058107148 -0.25343144910868037334 0.51746181127368018338 -0.87541502812745508599 0.25173923473562798137 0.57602194068408807404 0.70960705550157776589 0.031297574823035856362 -0.10034555607324777138 -0.63549939061892779524 -0.48944383333394930746;1.5642148054205768926 0.90778138195542634747 -0.1519341465597544294 0.91407837205966269156 -1.5378366570765320542 0.97508740763961498921 0.82126436554974979742 0.44156701074839455057 -0.44419168836117084442 -0.37925591492431720564 0.285106175121009775 0.32712949925939416307];
IW1_2 = [0.62774152630559731936 -0.67486972973676673249 -1.781174870404705235 0.063057259692247791261 -0.1611419835451808058 1.0755570742160247555;-1.8933167365072984811 1.5349436294866429797 1.0350351502890551281 2.2794716492911155648 -1.7876257110994215882 -0.77567812997890017712;-0.0029378348388875482472 0.3747328543977250237 0.051080152156368241467 -0.18080135085364865133 0.34759566631492444522 -0.28352985990718465592;0.71960884345804088102 0.13503925837913466346 2.0863238251547158164 0.26769827928804412753 -0.027875538453467171851 -0.71753954600340597025;1.0556635256737700868 1.3067206648913876066 -1.1273618395309767948 -0.26965355880774488639 -0.73732522232864061706 -0.019762264752706780457;0.14747565071969984118 -0.11152517801486748483 1.596766212150196429 -0.62398039499449708956 1.1201408974330953061 -1.4177427857105688869;-0.081920970548763322183 -0.69618811975955963156 0.89312758283238935508 -0.66262237106022892075 -0.27591437728967255216 1.1814298164727985441;0.92762877566420842701 -1.8531722325944950391 -0.324549025241775424 -3.0730458890761713775 1.9033283881476441568 0.021120568490376485232;-1.6262491936397112102 -0.097165757986845055494 -0.26672022147061186237 0.75161926829896874569 0.71039664678019087685 0.589846204757565995;-3.2635703380721232669 -0.26659412199895482498 -0.80151630615330260454 0.29750303941985806189 0.37798170903003164289 0.41865401422006376375];

% Layer 2
b2 = [-0.30914908775848970457;0.60270845715528098552;-0.29968268992840119136];
LW2_1 = [2.3697721754465517208 1.5931643591846902375 0.88972753272763238641 1.2332595075768957305 1.0633807356862954308 0.72261161835765241879 0.52577146767914439973 1.3233196957754513878 1.4158244502607031379 -0.35161319232960691616;0.5865034748587800717 -0.97500728364740507637 0.2685274509322003178 0.81324389559426590868 1.7260262507533719045 1.0210467263967981655 0.78926423754246932685 -1.1205656820514768857 -0.9792007944921862217 1.2829040911193791974;0.92749743285732411113 0.20006203595073976387 -1.8806596246066888956 0.85117826279512598386 0.72751176614694335054 1.5797723812714719038 0.34103730311455920932 -0.086918619801788332691 0.27122785273226984737 0.5119393215762872984];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0354831019441904;0.0377222788091497;0.0621721513247483];
y1_step1.xoffset = [-4.60253906;8.007185151;25.69303831];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(6,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),12,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
