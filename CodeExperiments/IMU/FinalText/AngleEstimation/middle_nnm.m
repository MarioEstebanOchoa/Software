function [y1,xf1,xf2] = middle_nnm(x1,x2,xi1,xi2)
%MIDDLE_NNM neural network simulation function.
%
% Auto-generated by MATLAB, 19-Sep-2019 17:21:22.
% 
% [y1,xf1,xf2] = middle_nnm(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 6xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 6x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 6x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [-33.3794195268759;-53.3588386163538;-13.5443328621949;-32.6258244121565;-54.0490170129025;-16.0220673198034];
x1_step1.gain = [0.0208432786207998;0.042177224182716;0.0752167513380959;0.021033281500451;0.0420727776313228;0.0706436629487186];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = [-34.05729511;-56.20691974;-10.00403908];
x2_step1.gain = [0.0211267846895733;0.0395706711489379;0.0871775967713017];
x2_step1.ymin = -1;

% Layer 1
b1 = [0.4218450900514044144;0.28204804553126244793;0.049195709764836330347;-0.10287000529048911934;0.86660409213936773209;-0.84323048544490575296;-0.38554258819708386863;0.27067260462942910326;0.15164470970495472213;0.44139357156658731718];
IW1_1 = [-0.82617498072655171093 1.2457894664530704265 1.615492375736800712 0.45255711224848521601 -0.57363198472311949239 0.19414517271703857215 -0.98587639742248212027 1.3577646922212891489 0.031118368698959272822 0.1934162847002166008 -0.64912691106913367189 -0.51744678410057554085;-0.36215956515909852875 0.12676395320327771277 -0.68669366729510394887 0.14181668273629194355 -0.096329402632740077084 -0.028048388247467987561 0.081645553718283081501 -0.24094512461120645708 -1.0467850747683282719 0.21138157521612471745 -0.39783921104903230415 0.42333924246470078234;0.77134199954903104324 0.51528017712014373419 2.2066325745672665803 -0.65555946887612470686 0.70898700014885840393 -1.2813744413954035739 -0.1351810435709339675 -0.086757703292759780211 -0.40245464426608040798 -0.52745900068643558622 -0.80238032061535302653 -0.046180626610567591939;1.2507377372243149161 -0.73474115439042053666 0.021766756541507597394 -0.33608242447239999873 0.34614850867746199681 -0.54906249732167344835 1.1164479822186499369 -0.37780699497853187374 0.022991722463744118654 0.056356535517023534365 0.19858631822740283046 0.17783038154030464395;0.56856151855062664335 -0.88994450989451356904 -1.5074077483863086435 -0.27697588845891984999 0.11840963810808820267 0.20198563345416550852 0.051884695089302247661 -1.3781529567127479563 0.64753380262209758733 0.11309595394494832699 1.1178499160175536797 0.63588601548109457973;-0.05555603208987872077 -1.0205540462327085116 0.092368557190488753683 0.69181136023789957523 -0.88149582634865575326 -0.22983578201579549227 -0.75003841883245980782 0.8020853751579517521 1.631161239032790311 0.55181603124243294722 0.55357805611914834287 0.29493464412125847129;-0.51004651623553665107 0.085178574310623908494 -1.3172720209738493224 0.52423010632462496705 -1.1196553581027643975 0.71938681460562481362 -0.59987236191824466758 0.1297623769740195443 0.11300325300404513718 0.074921151591742105036 0.14018774470244238506 0.57473189961757842337;0.0012338385351840495431 -0.050590694642046192542 -0.24126345145770530798 -0.031738493063765235713 0.058399590815945055799 -0.23378194063663795821 0.26202367419162175821 -0.2641686360375790632 -0.43524255769874248267 -0.085508905471258597752 -0.08556118129690673535 0.26730456995005563714;-0.82365797121760031541 1.0851475810698278934 -0.32814994723597651349 -0.49501474746701912277 0.70125094596495562982 0.82606817285687828001 -0.45211097379290188236 -0.64215147302406727636 -0.71531868861039760166 -0.59852189409112521723 -0.27482970864474159933 -0.63013752955949187129;0.64384084658964135794 -1.433830540931181563 -0.81454868926709245169 0.16731916460243390077 -0.4929759823653018791 -0.099025935572127604667 -0.61646933396525527282 -0.83331486775277130441 1.9506836702486616275 0.37452729071793466886 1.5520694732180591036 0.86493256773631455037];
IW1_2 = [0.92245180403934512459 0.61403510463652444251 -0.86172318827273619579 -0.76127798407425339988 -2.0977956162026605291 -0.54433068588972299828;-1.3522511318089767141 1.4415399247077000933 -0.71151777246990166592 1.0376011490261451975 -0.688362914477084753 1.7916602562956396305;4.1841642106284231417 0.87891860497972829069 -0.033305271215886611547 -3.5393133184740528385 -1.1130267832613103263 -0.49721215190322376465;-0.44335343031829188565 -1.0783437232297012898 0.55831000373124295422 -1.2288032766901759718 1.597767411300549778 -0.19275401181134324546;-0.48165789228665228938 0.64366740104803965572 0.8000098304799508897 0.59657290762787862359 1.099748018178732023 -0.56961976516613443966;-0.039894765902123277557 1.8429277869259674816 0.24261215086318513312 -0.57406620649415862623 -0.25712260422043270447 -1.7814097313476764395;-0.76909002978552232221 1.7651039920183790866 0.50322389976236703291 0.60727763721440219946 -1.0752971256246108833 -0.045681398577330063759;-0.2810403461468432007 -0.33543235941103988207 -0.38381565520829097338 0.17619221453226993623 0.28873783552436432798 0.68867672937150314905;0.79103624011020112761 -0.56816134700034026661 0.0049759523490669798143 1.4134292326250517124 -0.75332006569991594169 0.87895476350445567171;-0.39364683001509448435 2.033712583267916596 0.79941118860117033051 0.018266727138395950913 0.49551294137856449762 -2.2880612751977533748];

% Layer 2
b2 = [-0.96352866168444928352;0.16439289682926797043;0.35929460080077779693];
LW2_1 = [-1.1252532475955803193 -0.87089194689217919176 0.52056475247913680526 -2.852379640969306962 2.1214504988712601374 -1.6544435970104773848 -0.10255860046016429532 -1.2536378343915677291 -2.2992093298801696832 -1.4831439649031423755;-0.04643624986472973809 0.9060786725262295338 0.13102675499430052608 -0.0046796601535941196107 -0.19792361826790350054 0.28249810846846590273 -0.46994761976397225745 -1.2830789982873171962 0.092881590340041716991 0.25881434818858656266;-0.25218063875792839923 -0.26039391089087637887 -0.014081994137364396355 0.44102850820273531429 0.40224147930658304961 -0.56287542687054270552 0.78182971932731815112 -1.9344305471311564748 0.10361983421447856779 -0.32445595939141563813];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [0.0211267846895733;0.0395706711489379;0.0871775967713017];
y1_step1.xoffset = [-34.05729511;-56.20691974;-10.00403908];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(6,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),12,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
